<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ProStroy — Редактирование контрагента</title>
  <meta name="color-scheme" content="dark">
  <link rel="stylesheet" href="assets/styles/base.css">
  <link rel="stylesheet" href="assets/styles/header.css">
  <style>
    :root{
      --surface:rgba(6,10,18,.58);
      --border-soft:rgba(255,255,255,.12);
      --accent:#22c55e;
    }
    body{margin:0;min-height:100dvh;background:var(--bg,#0b1220);color:var(--text,#eef3f9);font-family:var(--font-sans,system-ui,-apple-system,"Segoe UI",Roboto,Inter,Arial);--bg-video-filter:brightness(.72)}
    video.bg{position:fixed;inset:0;width:100%;height:100%;object-fit:cover;z-index:-2}
    .wrap{padding:24px}
    .page{max-width:960px;margin:0 auto;display:grid;gap:20px}
    .card{background:var(--surface);border:1px solid var(--border-soft);border-radius:20px;padding:26px 30px;backdrop-filter:blur(8px);box-shadow:0 26px 50px rgba(0,0,0,.54);display:grid;gap:20px}
    header.header{display:flex;justify-content:space-between;gap:16px;align-items:flex-start;flex-wrap:wrap}
    h1{margin:0;font-size:1.8rem}
    .muted{color:var(--muted,#a9b4c7)}
    .actions{display:flex;gap:12px;flex-wrap:wrap}
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:10px 18px;border-radius:12px;border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.08);color:inherit;text-decoration:none;font-weight:600;transition:filter .2s ease,border-color .2s ease}
    .btn:hover{filter:brightness(1.05);border-color:rgba(255,255,255,.26)}
    .btn.primary{background:linear-gradient(135deg,var(--accent),#1ed760);border:0;color:#062a16;box-shadow:0 14px 32px rgba(34,197,94,.22)}
    form{display:grid;gap:22px}
    .row{display:grid;gap:6px}
    label{font-size:.95rem;color:#dee6f7}
    .inline{display:flex;gap:12px;flex-wrap:wrap}
    input,textarea,select{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.16);border-radius:12px;padding:10px 12px;color:inherit;font:inherit;outline:none;transition:border-color .2s ease}
    input:focus,textarea:focus,select:focus{border-color:rgba(191,223,255,.5)}
    textarea{min-height:96px;resize:vertical}
    .grid-2{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.18);font-size:.88rem;text-transform:uppercase;letter-spacing:.05em}
    .ok,.err{display:none;padding:12px 14px;border-radius:12px;font-size:.92rem}
    .ok{background:rgba(34,197,94,.16);border:1px solid rgba(34,197,94,.34);color:#bbf7d0}
    .err{background:rgba(248,113,113,.16);border:1px solid rgba(248,113,113,.34);color:#fecaca}
    .section{border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:18px 20px;background:rgba(255,255,255,.04);display:grid;gap:16px}
    .section h2{margin:0;font-size:1.08rem}
    .hint{font-size:.86rem;color:var(--muted)}
    @media(max-width:720px){
      .wrap{padding:18px}
      .card{padding:22px}
      h1{font-size:1.5rem}
      .actions{flex-direction:column}
      .btn{width:100%}
      .inline{flex-direction:column;align-items:flex-start}
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js" defer></script>
  <script src="/js/supabaseClient.js" defer></script>
  <script src="/header.js" defer></script>
</head>
<body>
  <video class="bg" autoplay muted loop playsinline preload="auto">
    <source src="https://assets.mixkit.co/videos/30431/30431-720.mp4" type="video/mp4">
  </video>
  <div id="header"></div>

  <div class="wrap">
    <div class="page">
      <section class="card">
        <header class="header">
          <div>
            <p class="muted" id="pageBreadcrumb">Редактирование контрагента</p>
            <h1 id="pageTitle">Загрузка…</h1>
          </div>
          <div class="actions">
            <a class="btn" id="viewBtn" href="./counterparty-view.html">Открыть карточку</a>
            <a class="btn" href="./counterparties-list.html">К списку</a>
          </div>
        </header>

        <form id="counterpartyForm" autocomplete="on">
          <div class="section">
            <h2>Основные сведения</h2>
            <div class="row">
              <label for="cp_type">Тип контрагента *</label>
              <div class="inline">
                <label class="badge"><input type="radio" name="cp_type" value="individual"> Физ лицо / ИП</label>
                <label class="badge"><input type="radio" name="cp_type" value="legal"> Юр лицо</label>
              </div>
            </div>
            <div class="row">
              <label for="cp_name">Полное наименование / ФИО *</label>
              <input id="cp_name" required placeholder="ООО «СтройСервис» или Иванов Иван Иванович">
            </div>
            <div class="grid-2">
              <div class="row">
                <label for="cp_role">Тип контрагента *</label>
                <select id="cp_role">
                  <option value="supplier" selected>Поставщик</option>
                  <option value="contractor">Подрядчик</option>
                  <option value="customer">Заказчик</option>
                  <option value="subcontractor">Субподрядчик</option>
                  <option value="leasing">Лизингодатель</option>
                  <option value="other">Другое</option>
                </select>
              </div>
              <div class="row">
                <label for="cp_status">Статус *</label>
                <select id="cp_status">
                  <option value="active" selected>Активен</option>
                  <option value="pending">На проверке</option>
                  <option value="blocked">Заблокирован</option>
                </select>
              </div>
            </div>
            <div class="grid-2">
              <div class="row">
                <label for="cp_manager">Ответственный менеджер / куратор</label>
                <input id="cp_manager" placeholder="ФИО или подразделение">
              </div>
              <div class="row">
                <label for="cp_tags">Теги / категории</label>
                <input id="cp_tags" placeholder="например: надежный, новый, просрочка">
              </div>
            </div>
            <div class="row">
              <label for="cp_objects">Привязанные объекты / примечания</label>
              <textarea id="cp_objects" placeholder="На каких объектах работает контрагент"></textarea>
            </div>
          </div>

          <div id="legalSection" class="section" hidden>
            <h2>Юридическое лицо</h2>
            <div class="grid-2">
              <div class="row">
                <label for="legal_inn">ИНН *</label>
                <input id="legal_inn" maxlength="10" placeholder="10 цифр">
              </div>
              <div class="row">
                <label for="legal_kpp">КПП</label>
                <input id="legal_kpp" maxlength="9" placeholder="9 цифр">
              </div>
            </div>
            <div class="grid-2">
              <div class="row">
                <label for="legal_ogrn">ОГРН *</label>
                <input id="legal_ogrn" maxlength="13" placeholder="13 цифр">
              </div>
              <div class="row">
                <label for="legal_ogrnip">ОГРНИП</label>
                <input id="legal_ogrnip" maxlength="15" placeholder="Для ИП">
              </div>
            </div>
            <div class="row">
              <label for="legal_legal_address">Юридический адрес *</label>
              <textarea id="legal_legal_address" placeholder="Как в учредительных документах"></textarea>
            </div>
            <div class="row">
              <label for="legal_post_address">Почтовый адрес</label>
              <textarea id="legal_post_address" placeholder="Если отличается от юридического"></textarea>
            </div>
            <div class="grid-2">
              <div class="row">
                <label for="legal_phone">Телефон *</label>
                <input id="legal_phone" placeholder="+7 (___) ___-__-__">
              </div>
              <div class="row">
                <label for="legal_email">Email *</label>
                <input id="legal_email" type="email" placeholder="info@company.ru">
              </div>
            </div>
            <div class="row">
              <label for="legal_site">Сайт / каталог</label>
              <input id="legal_site" placeholder="https://company.ru">
            </div>
            <div class="grid-2">
              <div class="row">
                <label for="legal_director_name">ФИО руководителя *</label>
                <input id="legal_director_name" placeholder="Генеральный директор Иванов И.И.">
              </div>
              <div class="row">
                <label for="legal_director_position">Должность руководителя *</label>
                <input id="legal_director_position" placeholder="Генеральный директор">
              </div>
            </div>
            <div class="row">
              <label for="legal_power_basis">Основание полномочий *</label>
              <input id="legal_power_basis" placeholder="Действует на основании Устава / по доверенности">
            </div>
            <div class="row">
              <label for="legal_power_file">Ссылка на доверенность</label>
              <input id="legal_power_file" placeholder="URL или путь к файлу">
            </div>
            <div class="grid-2">
              <div class="row">
                <label for="legal_bank_name">Банк *</label>
                <input id="legal_bank_name" placeholder="АО «Банк»">
              </div>
              <div class="row">
                <label for="legal_currency">Валюта расчётов *</label>
                <select id="legal_currency">
                  <option value="RUB" selected>RUB — рубли</option>
                  <option value="USD">USD — доллары</option>
                  <option value="EUR">EUR — евро</option>
                </select>
              </div>
            </div>
            <div class="grid-2">
              <div class="row">
                <label for="legal_bank_bik">БИК банка *</label>
                <input id="legal_bank_bik" placeholder="9 цифр" maxlength="9">
              </div>
              <div class="row">
                <label for="legal_bank_account">Расчётный счёт *</label>
                <input id="legal_bank_account" placeholder="20 цифр" maxlength="20">
              </div>
            </div>
            <div class="row">
              <label for="legal_bank_corr">Корреспондентский счёт</label>
              <input id="legal_bank_corr" placeholder="20 цифр" maxlength="20">
            </div>
            <div class="row">
              <label for="legal_bank_extra">Дополнительные реквизиты</label>
              <textarea id="legal_bank_extra" placeholder="SWIFT, особые условия"></textarea>
            </div>
            <div class="grid-2">
              <div class="row">
                <label for="legal_charter_file">Учредительные документы</label>
                <input id="legal_charter_file" placeholder="Ссылка на устав, выписку ЕГРЮЛ и т.д.">
              </div>
              <div class="row">
                <label for="legal_nda_file">NDA / рамочный договор</label>
                <input id="legal_nda_file" placeholder="https://...">
              </div>
            </div>
            <div class="row">
              <label for="legal_last_check">Дата последней проверки</label>
              <input id="legal_last_check" type="date">
            </div>
          </div>

          <div id="individualSection" class="section">
            <h2>Физическое лицо / ИП</h2>
            <div class="grid-2">
              <div class="row">
                <label for="ind_inn">ИНН *</label>
                <input id="ind_inn" maxlength="12" placeholder="12 цифр">
              </div>
              <div class="row">
                <label for="ind_snils">СНИЛС *</label>
                <input id="ind_snils" placeholder="000-000-000 00">
              </div>
            </div>
            <div class="grid-2">
              <div class="row">
                <label for="ind_tax_status">Статус налогоплательщика *</label>
                <select id="ind_tax_status">
                  <option value="resident" selected>Резидент РФ</option>
                  <option value="nonresident">Нерезидент РФ</option>
                </select>
              </div>
              <div class="row">
                <label for="ind_self_status">Статус деятельности</label>
                <select id="ind_self_status">
                  <option value="none" selected>Нет</option>
                  <option value="self_employed">Самозанятый</option>
                  <option value="sole_proprietor">Индивидуальный предприниматель</option>
                </select>
              </div>
            </div>
            <div class="grid-2">
              <div class="row">
                <label for="ind_passport_series">Паспорт — серия *</label>
                <input id="ind_passport_series" placeholder="0000" maxlength="4">
              </div>
              <div class="row">
                <label for="ind_passport_number">Паспорт — номер *</label>
                <input id="ind_passport_number" placeholder="000000" maxlength="6">
              </div>
            </div>
            <div class="row">
              <label for="ind_passport_issued">Кем и когда выдан *</label>
              <input id="ind_passport_issued" placeholder="ГУ МВД…, 01.01.2020">
            </div>
            <div class="row">
              <label for="ind_registration_address">Адрес регистрации *</label>
              <textarea id="ind_registration_address" placeholder="Город, улица, дом, квартира"></textarea>
            </div>
            <div class="grid-2">
              <div class="row">
                <label for="ind_bank_bik">БИК банка *</label>
                <input id="ind_bank_bik" placeholder="9 цифр" maxlength="9">
              </div>
              <div class="row">
                <label for="ind_bank_account">Расчётный счёт *</label>
                <input id="ind_bank_account" placeholder="20 цифр" maxlength="20">
              </div>
            </div>
          </div>

          <div class="section">
            <h2>Примечания</h2>
            <div class="row">
              <label for="cp_notes">Примечания</label>
              <textarea id="cp_notes" placeholder="Особые условия, комментарии"></textarea>
            </div>
          </div>

          <div class="hint" id="auditInfo"></div>

          <div class="inline">
            <button class="btn primary" type="submit" id="saveBtn">Сохранить изменения</button>
            <button class="btn" type="button" id="resetBtn">Сбросить</button>
          </div>
          <div id="ok" class="ok"></div>
          <div id="err" class="err"></div>
        </form>
      </section>
    </div>
  </div>

  <script type="module">
    import supabase, { requireSession } from "./supabaseClient.js";
    const headerReady = window.headerReady || Promise.resolve();

    const params = new URLSearchParams(location.search);
    const counterpartyId = params.get("id");

    const form = document.getElementById("counterpartyForm");
    const okBox = document.getElementById("ok");
    const errBox = document.getElementById("err");
    const pageTitle = document.getElementById("pageTitle");
    const viewBtn = document.getElementById("viewBtn");
    const auditInfo = document.getElementById("auditInfo");
    const saveBtn = document.getElementById("saveBtn");
    const resetBtn = document.getElementById("resetBtn");

    const legalSection = document.getElementById("legalSection");
    const individualSection = document.getElementById("individualSection");

    const field = id => document.getElementById(id);
    const normalizeDigits = value => (value || "").replace(/\s+/g, "").replace(/[^0-9]/g, "");
    const getValue = id => (field(id)?.value || "").trim();
    const setValue = (id, value) => { const el = field(id); if (el) el.value = value ?? ""; };
    const setSelectValue = (id, value, fallback) => {
      const el = field(id);
      if (!el) return;
      const options = Array.from(el.options || []);
      const values = options.map(opt => opt.value);
      if (value && values.includes(value)) el.value = value;
      else if (fallback && values.includes(fallback)) el.value = fallback;
      else if (options.length) el.selectedIndex = 0;
    };
    const setRadioValue = (name, value) => {
      const radios = form.querySelectorAll(`input[name="${name}"]`);
      radios.forEach(rad => { rad.checked = rad.value === value; });
    };
    const getRadioValue = name => form.querySelector(`input[name="${name}"]:checked`)?.value;
    const setRequired = (id, state) => {
      const el = field(id);
      if (!el) return;
      if (state) el.setAttribute("required", "required");
      else el.removeAttribute("required");
    };

    let initialData = null;

    const getType = () => getRadioValue("cp_type") || "individual";

    function updateFieldVisibility(type = getType()){
      const isLegal = type === "legal";
      legalSection.hidden = !isLegal;
      individualSection.hidden = isLegal;

      setRequired("legal_inn", isLegal);
      setRequired("legal_ogrn", isLegal);
      setRequired("legal_legal_address", isLegal);
      setRequired("legal_phone", isLegal);
      setRequired("legal_email", isLegal);
      setRequired("legal_director_name", isLegal);
      setRequired("legal_director_position", isLegal);
      setRequired("legal_power_basis", isLegal);
      setRequired("legal_bank_name", isLegal);
      setRequired("legal_bank_bik", isLegal);
      setRequired("legal_bank_account", isLegal);
      setRequired("legal_currency", isLegal);

      setRequired("ind_inn", !isLegal);
      setRequired("ind_snils", !isLegal);
      setRequired("ind_tax_status", !isLegal);
      setRequired("ind_passport_series", !isLegal);
      setRequired("ind_passport_number", !isLegal);
      setRequired("ind_passport_issued", !isLegal);
      setRequired("ind_registration_address", !isLegal);
      setRequired("ind_bank_bik", !isLegal);
      setRequired("ind_bank_account", !isLegal);
    }

    function fillForm(data){
      initialData = data;
      const type = data.type || "individual";
      setRadioValue("cp_type", type);
      updateFieldVisibility(type);

      setValue("cp_name", data.name || "");
      setSelectValue("cp_role", data.role || "supplier", "supplier");
      setSelectValue("cp_status", data.status || "active", "active");
      setValue("cp_manager", data.manager || "");
      setValue("cp_tags", data.tags || "");
      setValue("cp_objects", data.linked_objects || "");
      setValue("cp_notes", data.notes || "");

      if (type === "legal"){
        setValue("legal_inn", data.inn || "");
        setValue("legal_kpp", data.kpp || "");
        setValue("legal_ogrn", data.ogrn || "");
        setValue("legal_ogrnip", data.ogrnip || "");
        setValue("legal_legal_address", data.legal_address || "");
        setValue("legal_post_address", data.post_address || "");
        setValue("legal_phone", data.phone || "");
        setValue("legal_email", data.email || "");
        setValue("legal_site", data.site || "");
        setValue("legal_director_name", data.director_name || data.director || "");
        setValue("legal_director_position", data.director_position || "");
        setValue("legal_power_basis", data.power_basis || "");
        setValue("legal_power_file", data.power_file || "");
        setValue("legal_bank_name", data.bank_name || "");
        setValue("legal_bank_bik", data.bank_bik || "");
        setValue("legal_bank_account", data.bank_account || "");
        setValue("legal_bank_corr", data.bank_corr || "");
        setValue("legal_bank_extra", data.bank_details || "");
        setSelectValue("legal_currency", data.currency || "RUB", "RUB");
        setValue("legal_charter_file", data.charter_file || "");
        setValue("legal_nda_file", data.nda_file || "");
        setValue("legal_last_check", data.last_check_date || "");
      } else {
        setValue("ind_inn", data.inn || "");
        setValue("ind_snils", data.snils || "");
        setSelectValue("ind_tax_status", data.tax_status || "resident", "resident");
        setSelectValue("ind_self_status", data.self_status || "none", "none");
        setValue("ind_passport_series", data.passport_series || "");
        setValue("ind_passport_number", data.passport_number || "");
        setValue("ind_passport_issued", data.passport_issued || "");
        setValue("ind_registration_address", data.registration_address || "");
        setValue("ind_bank_bik", data.bank_bik || "");
        setValue("ind_bank_account", data.bank_account || "");
      }

      auditInfo.textContent = data.created_at ? `Создан: ${new Date(data.created_at).toLocaleString("ru-RU")}` : "";
    }

    form.addEventListener("change", evt => {
      if (evt.target?.name === "cp_type"){
        updateFieldVisibility(evt.target.value);
      }
    });

    function collectPayload(type){
      const name = getValue("cp_name");
      if (!name) return { error: "Укажите наименование контрагента." };

      const role = field("cp_role")?.value || "supplier";
      const status = field("cp_status")?.value || "active";
      const manager = getValue("cp_manager") || null;
      const tags = getValue("cp_tags") || null;
      const linkedObjects = getValue("cp_objects") || null;
      const notes = getValue("cp_notes") || null;

      const payload = {
        type,
        role,
        status,
        name,
        title: name,
        manager,
        tags,
        linked_objects: linkedObjects,
        notes
      };

      if (type === "legal"){
        const inn = normalizeDigits(getValue("legal_inn"));
        if (inn.length !== 10) return { error: "ИНН организации должен содержать 10 цифр." };
        const ogrn = normalizeDigits(getValue("legal_ogrn"));
        if (ogrn.length !== 13) return { error: "ОГРН должен содержать 13 цифр." };
        const phone = getValue("legal_phone");
        const email = getValue("legal_email");
        if (!phone || !email) return { error: "Укажите телефон и email организации." };
        const legalAddress = getValue("legal_legal_address");
        if (!legalAddress) return { error: "Заполните юридический адрес." };
        const directorName = getValue("legal_director_name");
        const directorPosition = getValue("legal_director_position");
        if (!directorName || !directorPosition) return { error: "Укажите ФИО и должность руководителя." };
        const powerBasis = getValue("legal_power_basis");
        if (!powerBasis) return { error: "Укажите основание полномочий руководителя." };
        const bankName = getValue("legal_bank_name");
        if (!bankName) return { error: "Укажите наименование банка." };
        const bankBik = normalizeDigits(getValue("legal_bank_bik"));
        if (bankBik.length !== 9) return { error: "БИК должен содержать 9 цифр." };
        const bankAccount = normalizeDigits(getValue("legal_bank_account"));
        if (bankAccount.length !== 20) return { error: "Расчётный счёт должен содержать 20 цифр." };
        const bankCorr = normalizeDigits(getValue("legal_bank_corr"));

        payload.inn = inn;
        payload.kpp = normalizeDigits(getValue("legal_kpp")) || null;
        payload.ogrn = ogrn;
        payload.ogrnip = normalizeDigits(getValue("legal_ogrnip")) || null;
        payload.legal_address = legalAddress;
        payload.post_address = getValue("legal_post_address") || null;
        payload.phone = phone;
        payload.email = email;
        payload.site = getValue("legal_site") || null;
        payload.director = directorName;
        payload.director_name = directorName;
        payload.director_position = directorPosition;
        payload.power_basis = powerBasis;
        payload.power_file = getValue("legal_power_file") || null;
        payload.bank_name = bankName;
        payload.bank_bik = bankBik;
        payload.bank_account = bankAccount;
        payload.bank_corr = bankCorr ? bankCorr : null;
        payload.bank_details = getValue("legal_bank_extra") || null;
        payload.currency = field("legal_currency")?.value || "RUB";
        payload.charter_file = getValue("legal_charter_file") || null;
        payload.nda_file = getValue("legal_nda_file") || null;
        payload.last_check_date = getValue("legal_last_check") || null;

        const contactParts = [phone, email].filter(Boolean);
        if (!contactParts.length) contactParts.push(legalAddress);
        payload.contact = contactParts.filter(Boolean).join(" / ") || name;
      } else {
        const inn = normalizeDigits(getValue("ind_inn"));
        if (!inn || !(inn.length === 12 || inn.length === 10)) return { error: "ИНН должен содержать 10 или 12 цифр." };
        const snils = normalizeDigits(getValue("ind_snils"));
        if (snils.length !== 11) return { error: "СНИЛС должен содержать 11 цифр." };
        const passportSeries = normalizeDigits(getValue("ind_passport_series"));
        const passportNumber = normalizeDigits(getValue("ind_passport_number"));
        if (passportSeries.length !== 4 || passportNumber.length !== 6) return { error: "Паспорт: серия 4 цифры и номер 6 цифр." };
        const passportIssued = getValue("ind_passport_issued");
        if (!passportIssued) return { error: "Укажите, кем и когда выдан паспорт." };
        const registrationAddress = getValue("ind_registration_address");
        if (!registrationAddress) return { error: "Заполните адрес регистрации." };
        const bankBik = normalizeDigits(getValue("ind_bank_bik"));
        if (bankBik.length !== 9) return { error: "БИК должен содержать 9 цифр." };
        const bankAccount = normalizeDigits(getValue("ind_bank_account"));
        if (bankAccount.length !== 20) return { error: "Расчётный счёт должен содержать 20 цифр." };

        payload.inn = inn;
        payload.snils = snils;
        payload.tax_status = field("ind_tax_status")?.value || "resident";
        payload.self_status = field("ind_self_status")?.value || "none";
        payload.passport_series = passportSeries;
        payload.passport_number = passportNumber;
        payload.passport = `${passportSeries} ${passportNumber}`;
        payload.passport_issued = passportIssued;
        payload.registration_address = registrationAddress;
        payload.bank_bik = bankBik;
        payload.bank_account = bankAccount;
        payload.bank_corr = null;
        payload.bank_details = null;
        payload.phone = null;
        payload.email = null;
        payload.bank_name = null;
        payload.currency = null;
        payload.site = null;
        payload.charter_file = null;
        payload.nda_file = null;
        payload.last_check_date = null;
        payload.director = null;
        payload.director_name = null;
        payload.director_position = null;
        payload.power_basis = null;
        payload.power_file = null;
        payload.post_address = null;

        payload.contact = registrationAddress || name;
      }

      return { payload };
    }

    function clearMessages(){
      okBox.style.display = "none";
      errBox.style.display = "none";
      okBox.textContent = "";
      errBox.textContent = "";
    }

    function showMessage(target, message){
      target.textContent = message;
      target.style.display = "block";
    }

    await headerReady;
    await requireSession({ redirectTo: "./index.html" });

    if (!counterpartyId){
      pageTitle.textContent = "Контрагент не найден";
      form.remove();
      document.querySelector(".card").insertAdjacentHTML("beforeend", '<div class="err" style="display:block">Не передан идентификатор контрагента.</div>');
      viewBtn.remove();
    } else {
      viewBtn.href = `./counterparty-view.html?id=${encodeURIComponent(counterpartyId)}`;
      const { data, error } = await supabase
        .from("counterparties")
        .select("*")
        .eq("id", counterpartyId)
        .maybeSingle();

      if (error || !data){
        console.error("[counterparty-edit] load error", error);
        pageTitle.textContent = "Контрагент не найден";
        form.remove();
        document.querySelector(".card").insertAdjacentHTML("beforeend", '<div class="err" style="display:block">Не удалось загрузить контрагента. Возможно, запись удалена.</div>');
        viewBtn.remove();
      } else {
        pageTitle.textContent = data.name || "(без названия)";
        fillForm(data);

        form.addEventListener("change", evt=>{
          if (evt.target?.name === "cp_type"){
            updateFieldVisibility(evt.target.value);
          }
        });

        resetBtn.addEventListener("click", ()=>{
          if (initialData) fillForm(initialData);
          clearMessages();
        });

        form.addEventListener("submit", async evt=>{
          evt.preventDefault();
          clearMessages();

          const type = getType();
          const { payload, error: validationError } = collectPayload(type);
          if (validationError){
            showMessage(errBox, validationError);
            return;
          }

          saveBtn.disabled = true;
          saveBtn.textContent = "Сохраняем…";

          try{
            const { error: updateError } = await supabase
              .from("counterparties")
              .update(payload)
              .eq("id", counterpartyId);
            if (updateError) throw updateError;

            showMessage(okBox, "Изменения сохранены.");
            pageTitle.textContent = payload.name || pageTitle.textContent;
            initialData = { ...initialData, ...payload };
          }catch(ex){
            console.error("[counterparty-edit] update error", ex);
            showMessage(errBox, ex?.message || "Не удалось сохранить изменения.");
          }finally{
            saveBtn.disabled = false;
            saveBtn.textContent = "Сохранить изменения";
          }
        });
      }
    }
  </script>
</body>
</html>
