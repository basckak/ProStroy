<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ProStroy — Договор ГПХ</title>
  <meta name="color-scheme" content="dark">
  <link rel="stylesheet" href="../../assets/styles/base.css">
  <link rel="stylesheet" href="../../assets/styles/header.css">
  <style>
    :root{
      --surface:rgba(8,12,20,.72);
      --border:rgba(255,255,255,.12);
      --muted:#97a6bf;
      --danger:#f87171;
    }
    body{margin:0;min-height:100dvh;background:var(--bg,#0b1220);color:var(--text,#eef3f9);font-family:var(--font-sans,system-ui,-apple-system,"Segoe UI",Roboto,Inter,Arial);overflow-y:scroll}
    video.bg{position:fixed;inset:0;width:100%;height:100%;object-fit:cover;z-index:-2;filter:brightness(.7)}
    .overlay{position:fixed;inset:0;background:linear-gradient(180deg,rgba(5,8,13,.24),rgba(5,8,13,.8));z-index:-1}
    .wrap{padding:28px;display:flex;justify-content:center}
    .form-container{width:min(1180px,100%);margin:0 auto;background:var(--surface);border:1px solid var(--border);border-radius:24px;padding:36px 42px;backdrop-filter:blur(18px);box-shadow:0 28px 60px rgba(0,0,0,.6);display:grid;gap:30px;box-sizing:border-box}
    .form-container > *{width:100%;box-sizing:border-box}
    .form-header{display:flex;justify-content:space-between;align-items:flex-start;gap:20px;flex-wrap:wrap}
    .form-header h1{margin:4px 0 0;font-size:1.85rem;letter-spacing:.02em}
    .form-mode{margin:0;font-size:.9rem;color:var(--muted);text-transform:uppercase;letter-spacing:.14em;font-weight:600}
    form{display:grid;gap:26px}
    .field-group{display:grid;gap:18px}
    .field{display:grid;gap:6px}
    .field-row{display:grid;gap:18px;grid-template-columns:repeat(auto-fit,minmax(240px,1fr))}
    .field-row.tight{display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); align-items: start}
    label{font-size:.95rem;color:#dbe3f7;font-weight:600}
    label .req{color:#fca5a5;margin-left:6px}
    input,select,textarea{width:100%;max-width:100%;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.16);border-radius:12px;padding:12px 14px;color:inherit;font:inherit;min-height:48px}
    textarea{resize:vertical;min-height:120px}
    select option{color:#0f172a}
    .inline-checkbox{display:flex;align-items:center;gap:10px}
    .inline-checkbox input{width:auto;min-height:auto}
    .hint{font-size:.86rem;color:var(--muted);margin-top:4px}
    .alert{padding:12px 14px;border-radius:12px;font-size:.9rem}
    .alert.error{background:rgba(248,113,113,.16);border:1px solid rgba(248,113,113,.28);color:#ffc1c1}
    details.section{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.08);border-radius:18px;padding:20px 22px}
    details.section summary{cursor:pointer;font-weight:650;font-size:1.04rem;letter-spacing:.01em;margin:-20px -22px 18px;padding:20px 22px;border-radius:18px;color:#f1f5f9;list-style:none}
    details.section[open] summary{background:rgba(255,255,255,.04)}
    details.section summary::-webkit-details-marker{display:none}
    .section-grid{display:grid;gap:18px}
    .button-row{display:flex;gap:12px;flex-wrap:wrap;justify-content:flex-end}
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:12px 22px;border-radius:12px;border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.08);color:#f8fafc;font-weight:600;cursor:pointer;transition:filter .2s,border-color .2s}
    .btn:hover{filter:brightness(1.05);border-color:rgba(255,255,255,.24)}
    .btn.action{background:#22c55e;border:0;color:#0b1b14;box-shadow:0 14px 32px rgba(34,197,94,.2)}
    .btn.link{padding:10px 16px;background:transparent;border:1px solid rgba(255,255,255,.14)}
    body.has-modal{overflow:hidden}
    #formMessage{display:none;margin-top:-8px;padding:12px 16px;border-radius:12px;font-size:.92rem;font-weight:500}
    #formMessage.ok{display:block;background:rgba(34,197,94,.16);border:1px solid rgba(34,197,94,.32);color:#bbf7d0}
    #formMessage.err{display:block;background:rgba(248,113,113,.16);border:1px solid rgba(248,113,113,.3);color:#fecaca}
    .approval-section{background:rgba(255,255,255,.04);border:1px solid rgba(148,163,184,.22);border-radius:18px;padding:24px 26px;display:grid;gap:22px;box-shadow:0 22px 42px rgba(8,12,20,.34)}
    .approval-section[hidden]{display:none!important}
    .approval-section__head{display:flex;align-items:flex-start;justify-content:space-between;gap:16px;flex-wrap:wrap}
    .approval-section__title{margin:0;font-size:1.36rem;letter-spacing:.015em}
    .approval-section__description{margin:4px 0 0;font-size:.9rem;color:var(--muted);max-width:520px}
    .approval-section__body{display:grid;gap:18px}
    .approval-card{padding:18px 20px;border-radius:16px;border:1px solid rgba(148,163,184,.24);background:linear-gradient(145deg,rgba(19,31,49,.94),rgba(12,22,39,.86));box-shadow:0 18px 36px rgba(8,12,20,.32);display:grid;gap:18px}
    .approval-card__header{display:flex;align-items:flex-start;justify-content:space-between;gap:18px;flex-wrap:wrap}
    .approval-card__title{margin:0;font-size:1.14rem;letter-spacing:.015em}
    .approval-card__meta{margin:6px 0 18px;font-size:.86rem;color:var(--muted);display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .approval-card__actions{display:flex;gap:12px;flex-wrap:wrap}
    .approval-card__actions .btn{min-width:200px}
    .approval-card__actions .btn.link{padding:12px 20px}
    .approval-table-wrapper{overflow:hidden;border-radius:14px;border:1px solid rgba(148,163,184,.18)}
    .appr-table{width:100%;border-collapse:collapse;min-width:560px;background:rgba(15,23,42,.78)}
    .appr-table thead{background:rgba(148,163,184,.14)}
    .appr-table thead th{padding:8px 14px;text-align:center;font-size:.72rem;letter-spacing:.09em;text-transform:uppercase;color:#e2e8f0;border-bottom:1px solid rgba(148,163,184,.24)}
    .appr-table tbody td{padding:12px 16px;border-bottom:1px solid rgba(148,163,184,.14);font-size:.86rem;vertical-align:middle;text-align:center;border-bottom:0}
    .appr-table tbody tr{background:rgba(24,34,53,.72);position:relative}
    .appr-table tbody tr::after{content:"";position:absolute;left:0;right:0;bottom:0;border-bottom:1px solid rgba(148,163,184,.14)}
    .appr-table tbody tr:last-child::after{display:none}
    .appr-table tr[data-status="pending"]{background:linear-gradient(135deg,rgba(37,99,235,.18),rgba(15,23,42,.78))}
    .appr-table tr[data-status="approved"]{background:linear-gradient(135deg,rgba(34,197,94,.2),rgba(15,32,30,.78))}
    .appr-table tr[data-status="rejected"]{background:linear-gradient(135deg,rgba(239,68,68,.2),rgba(40,18,26,.78))}
    .appr-table td[data-label]{position:relative}
    .appr-cell-inner{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;width:100%;height:100%;min-height:100px}
    .appr-cell-user{min-width:220px}
    .appr-user-name{font-weight:600;font-size:.9rem}
    .appr-user-meta{margin-top:4px;font-size:.78rem;color:var(--muted)}
    .appr-status-cell{display:flex;flex-direction:column;gap:8px;min-width:180px;padding:0}
    .approval-status-line{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;width:100%;height:100%}
    .badge.badge--double{display:flex;flex-direction:column;gap:0;padding:6px 16px;text-transform:none;font-size:.78rem;line-height:1.1;min-width:160px;align-items:center;justify-content:center;height:50px}
    .badge.badge--double span{display:block;text-transform:none;white-space:nowrap}
    .appr-cell-comment{min-width:280px}
    .appr-status-comment{font-size:.84rem;color:var(--muted);white-space:pre-wrap;margin:0;text-align:center}
    .appr-comment-input{width:100%;text-align:center}
    .appr-actions{min-width:160px;padding:0}
    .appr-actions-wrap{display:flex;flex-direction:row;gap:10px;flex-wrap:wrap;align-items:center;justify-content:center;width:100%}
    .appr-actions .btn{min-width:140px;font-size:.82rem;white-space:nowrap}
    .appr-actions .muted{font-size:.82rem}
    .appr-empty{padding:22px 18px;border-radius:14px;border:1px dashed rgba(148,163,184,.28);background:rgba(15,23,42,.62);font-size:.9rem;color:var(--muted);text-align:center}
    .button-row.hidden{display:none!important}
    .approver-modal{position:fixed;inset:0;background:rgba(3,7,16,.74);display:grid;place-items:center;z-index:50}
    .approver-modal[hidden]{display:none!important}
    .approver-modal__panel{width:min(640px,calc(100% - 40px));max-height:90dvh;background:rgba(12,21,37,.95);border-radius:20px;border:1px solid rgba(255,255,255,.12);box-shadow:0 40px 80px rgba(0,0,0,.6);display:grid;grid-template-rows:auto 1fr auto}
    .approver-modal__head{display:flex;align-items:center;justify-content:space-between;padding:20px 24px;border-bottom:1px solid rgba(255,255,255,.08)}
    .approver-modal__title{margin:0;font-size:1.18rem}
    .approver-modal__close{background:transparent;border:0;color:#cbd5f5;font-size:1.8rem;cursor:pointer;padding:2px 8px}
    .approver-modal__body{padding:22px 24px;display:grid;gap:18px;overflow:auto}
    .approver-modal__actions{padding:18px 24px;border-top:1px solid rgba(255,255,255,.08);display:flex;justify-content:flex-end;gap:12px}
    .approver-search{position:relative;display:flex;flex-wrap:wrap;gap:8px;align-items:center;padding:10px 12px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.16);border-radius:12px}
    .approver-search__input{flex:1 1 180px;min-width:140px;background:transparent;border:0;outline:none;color:inherit;font:inherit}
    .approver-selected{display:flex;flex-wrap:wrap;gap:6px}
    .approver-selected.empty::before{content:"Никто не выбран";color:var(--muted);font-size:.86rem}
    .approver-tag{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:rgba(148,163,184,.22);font-size:.82rem}
    .approver-remove{background:transparent;border:0;color:#cbd5f5;cursor:pointer;font-size:1rem;line-height:1}
    .approver-options{position:absolute;top:calc(100% + 8px);left:0;right:0;background:rgba(15,23,42,.98);border:1px solid rgba(255,255,255,.14);border-radius:12px;box-shadow:0 22px 44px rgba(0,0,0,.45);max-height:220px;overflow:auto;z-index:10;padding:6px 0}
    .approver-option{padding:10px 14px;cursor:pointer}
    .approver-option:hover{background:rgba(255,255,255,.08)}
    .approval-card h3{margin:0 0 12px;font-size:1.08rem;letter-spacing:.01em}
    .approval-card .muted{font-size:.86rem}
    @media(max-width:960px){
      .approval-table-wrapper .appr-table{min-width:560px}
    }
    @media(max-width:900px){
      .wrap{padding:20px}
      .form-container{padding:28px 22px;border-radius:20px}
      .field-row{grid-template-columns:1fr}
    }
    @media(max-width:720px){
      .wrap{padding:20px;display:block}
      .form-container{padding:22px}
      .form-header h1{font-size:1.58rem}
      .button-row{flex-direction:column;align-items:stretch}
      .button-row .btn{width:100%}
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js" defer></script>
  <script src="/js/supabaseClient.js" defer></script>
  <script src="/header.js" defer></script>
</head>
<body>
  <video class="bg" autoplay muted loop playsinline preload="auto">
    <source src="https://assets.mixkit.co/videos/30431/30431-720.mp4" type="video/mp4">
  </video>
  <div class="overlay"></div>
  <div id="header"></div>

  <div class="wrap">
    <div class="form-container">
      <header class="form-header">
        <div>
          <p id="formModeLabel" class="form-mode">Создание</p>
          <h1>Договор ГПХ</h1>
        </div>
        <div id="docStatusPill" class="status-badge status-draft">Черновик</div>
      </header>

      <form id="docForm" novalidate>
        <section class="field-group">
          <div class="field">
            <label for="title">Название документа<span class="req">*</span></label>
            <input id="title" name="title" required placeholder="Договор ГПХ с Ивановым И.И.">
          </div>
          <div class="field-row tight">
            <div class="field">
              <label for="number">Номер договора<span class="req">*</span></label>
              <input id="number" name="number" required placeholder="Например: ГПХ-07/2025">
            </div>
            <div class="field">
              <label for="doc_date">Дата договора<span class="req">*</span></label>
              <input id="doc_date" name="doc_date" type="date" required>
            </div>
            <div class="field">
              <label for="fldObject">Объект<span class="req">*</span></label>
              <select id="fldObject" name="object_id" required></select>
            </div>
          </div>
          <div class="field-row tight">
            <div class="field">
              <label for="fldPayer">Плательщик (контрагент 1)<span class="req">*</span></label>
              <select id="fldPayer" name="counterparty_id" required></select>
            </div>
            <div class="field">
              <label for="fldExecutor">Исполнитель (контрагент 2)<span class="req">*</span></label>
              <select id="fldExecutor" name="counterparty2_id" required></select>
            </div>
          </div>
          <div id="refsError" class="alert error" hidden></div>
        </section>

        <details class="section" open>
          <summary>Предмет и сроки</summary>
          <div class="section-grid">
            <div class="field">
              <label for="service_scope">Предмет / вид услуг<span class="req">*</span></label>
              <textarea id="service_scope" name="service_scope" required placeholder="Что делает исполнитель: описание работ, задачи, ожидаемый результат."></textarea>
            </div>
            <div class="field-row tight">
              <div class="field">
                <label for="period_start">Период — с</label>
                <input id="period_start" name="period_start" type="date">
              </div>
              <div class="field">
                <label for="period_end">Период — по</label>
                <input id="period_end" name="period_end" type="date">
              </div>
              <div class="field">
                <label for="work_volume">Количество (часы / услуги)</label>
                <input id="work_volume" name="work_volume" placeholder="Например: 80 часов или 10 консультаций">
              </div>
            </div>
            <div class="field">
              <label for="curator">Ответственный куратор</label>
              <input id="curator" name="curator" placeholder="ФИО проектного менеджера">
            </div>
          </div>
        </details>

        <details class="section" open>
          <summary>Расчёты и выплаты</summary>
          <div class="section-grid">
            <div class="field-row tight">
              <div class="field">
                <label for="amount">Сумма вознаграждения, ₽<span class="req">*</span></label>
                <input id="amount" name="amount" inputmode="decimal" placeholder="0,00" required>
                <div class="hint">Укажите итоговую сумму за период или ставку за единицу работы.</div>
              </div>
              <div class="field field-full">
                <label for="payment_terms">Порядок расчётов<span class="req">*</span></label>
                <textarea id="payment_terms" name="payment_terms" required placeholder="Аванс, оплата по актам, сроки перечислений, реквизиты."></textarea>
              </div>
            </div>
            <div class="field">
              <label class="inline-checkbox">
                <input id="only_after_act" name="only_after_act" type="checkbox" value="yes">
                <span>Оплата только после акта</span>
              </label>
            </div>
            <div class="field field-full">
              <label for="payment_details">Реквизиты для перечисления</label>
              <textarea id="payment_details" name="payment_details" placeholder="Счёт, банк, комментарии для платежа."></textarea>
            </div>
          </div>
        </details>

        <details class="section">
          <summary>Налоги и удержания</summary>
          <div class="section-grid">
            <div class="field-row tight">
              <div class="field">
                <label for="ndfl_rate">Ставка НДФЛ<span class="req">*</span></label>
                <select id="ndfl_rate" name="ndfl_rate" required>
                  <option value="13">13%</option>
                  <option value="15">15%</option>
                  <option value="30">30%</option>
                </select>
                <div class="hint">Автоподстановка по статусу исполнителя, можно изменить вручную.</div>
              </div>
              <div class="field">
                <label for="insurance_required">Страховые взносы</label>
                <select id="insurance_required" name="insurance_required">
                  <option value="yes">Начислять</option>
                  <option value="no">Не начислять</option>
                </select>
              </div>
              <div class="field">
                <label for="withholdings">Удержания / вычеты</label>
                <input id="withholdings" name="withholdings" placeholder="Например: 13% НДФЛ, 1% удержания">
              </div>
            </div>
            <div class="field">
              <label for="tax_notes">Комментарии к расчётам</label>
              <textarea id="tax_notes" name="tax_notes" placeholder="Особенности налогообложения, подтверждающие документы."></textarea>
            </div>
          </div>
        </details>

        <section class="field-group">
          <div class="field">
            <label for="file">Файл договора<span class="req">*</span></label>
            <input id="file" name="file" type="file" accept=".pdf,.doc,.docx,.xls,.xlsx">
            <div id="currentFileLink" class="hint"></div>
          </div>
          <div class="field">
            <label for="notes">Примечания</label>
            <textarea id="notes" name="notes" placeholder="Основание работ, ТЗ, ссылка на переписку."></textarea>
          </div>
        </section>

        <div id="formMessage"></div>

        <div class="button-row">
          <button id="btnSave" type="submit" class="btn link" data-action="save">Сохранить черновик</button>
          <button id="btnSubmitApproval" type="submit" class="btn action" data-action="submit">Отправить на согласование</button>
        </div>
      </form>

      <section id="approvalSection" class="approval-section" hidden>
        <div class="approval-section__head">
          <div>
            <h2 class="approval-section__title">Согласование документа</h2>
            <p class="approval-section__description">Назначьте согласующих перед отправкой. Статусы будут обновляться автоматически.</p>
          </div>
        </div>
        <div class="approval-section__body">
          <div id="approvalBlockCard" class="approval-card" hidden>
            <div class="muted" id="approvalBlockHint">После выбора согласующих и отправки документ обновит состав и статусы.</div>
            <div id="approval-block-mount"></div>
          </div>
        </div>
        <div id="approverModal" class="approver-modal" hidden>
          <div class="approver-modal__panel">
            <div class="approver-modal__head">
              <h3 class="approver-modal__title">Назначить согласующих</h3>
              <button type="button" class="approver-modal__close" id="approverModalClose" aria-label="Закрыть окно">&times;</button>
            </div>
            <div class="approver-modal__body">
              <div class="field" id="approverPickerField" hidden>
                <label for="approversSearch">Выберите сотрудников</label>
                <div id="approversSelect" class="approver-search">
                  <div id="approversDisplay" class="approver-selected empty" aria-live="polite"></div>
                  <input id="approversSearch" class="approver-search__input" type="search" placeholder="Начните вводить фамилию, должность или email" autocomplete="off" spellcheck="false">
                  <div id="approversOptions" class="approver-options" role="listbox" aria-multiselectable="true"></div>
                </div>
                <div class="hint" id="approversHelp">Начните ввод фамилии, должности или email.</div>
              </div>
            </div>
            <div class="approver-modal__actions">
              <button type="button" class="btn link" id="approverModalCancel">Отмена</button>
              <button type="button" class="btn action" id="approverModalApply">Готово</button>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <script type="module" src="/js/contracts-service-gph.js"></script>
</body>
</html>
