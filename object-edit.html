<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ProStroy — Редактирование объекта</title>
  <meta name="color-scheme" content="dark">
  <link rel="stylesheet" href="assets/styles/base.css">
  <link rel="stylesheet" href="assets/styles/header.css">
  <style>
    body{margin:0;min-height:100dvh;background:var(--bg);color:var(--text);font-family:var(--font-sans);--bg-video-filter:brightness(.72)}
    video.bg{position:fixed;inset:0;width:100%;height:100%;object-fit:cover;z-index:-2}
    .wrap{padding:24px}
    .page{max-width:960px;margin:0 auto;display:grid;gap:20px}
    .card{background:var(--surface);border:1px solid var(--border-soft);border-radius:20px;padding:26px 30px;backdrop-filter:blur(8px);box-shadow:0 26px 50px rgba(0,0,0,.54);display:grid;gap:20px}
    h1{margin:0;font-size:1.8rem}
    .muted{color:var(--muted)}
    .actions{display:flex;gap:12px;flex-wrap:wrap}
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:10px 18px;border-radius:12px;border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.08);color:inherit;text-decoration:none;font-weight:600;transition:filter .2s ease,border-color .2s ease}
    .btn:hover{filter:brightness(1.05);border-color:rgba(255,255,255,.26)}
    .btn.primary{background:#22c55e;border:0;color:#062a16;box-shadow:0 14px 32px rgba(34,197,94,.22)}
    form{display:grid;gap:18px}
    .row{display:grid;gap:6px}
    label{font-size:.95rem;color:#dce5f5}
    input,textarea,select{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.16);border-radius:12px;padding:10px 12px;color:inherit;font:inherit;outline:none;transition:border-color .2s ease}
    input:focus,textarea:focus,select:focus{border-color:rgba(191,223,255,.52)}
    textarea{min-height:96px;resize:vertical}
    .grid-2{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px}
    .inline{display:flex;gap:12px;flex-wrap:wrap}
    .ok,.err{display:none;padding:12px 14px;border-radius:12px;font-size:.92rem}
    .ok{background:rgba(34,197,94,.16);border:1px solid rgba(34,197,94,.34);color:#bbf7d0}
    .err{background:rgba(248,113,113,.16);border:1px solid rgba(248,113,113,.34);color:#fecaca}
    .hint{font-size:.86rem;color:var(--muted)}
    @media(max-width:720px){
      .wrap{padding:18px}
      .card{padding:22px}
      h1{font-size:1.5rem}
      .actions{flex-direction:column}
      .btn{width:100%}
      .inline{flex-direction:column;align-items:flex-start}
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js" defer></script>
  <script src="/js/supabaseClient.js" defer></script>
  <script src="/header.js" defer></script>
</head>
<body>
  <video class="bg" autoplay muted loop playsinline preload="auto">
    <source src="https://assets.mixkit.co/videos/30431/30431-720.mp4" type="video/mp4">
  </video>
  <div id="header"></div>

  <div class="wrap">
    <div class="page">
      <section class="card">
        <header class="header">
          <div>
            <p class="muted" id="pageBreadcrumb">Редактирование объекта</p>
            <h1 id="pageTitle">Загрузка…</h1>
          </div>
          <div class="actions">
            <a class="btn" id="viewBtn" href="./object-view.html">Открыть карточку</a>
            <a class="btn" href="./objects-list.html">К списку</a>
          </div>
        </header>

        <form id="objectForm" autocomplete="on">
          <div class="row">
            <label for="title">Название объекта *</label>
            <input id="title" required placeholder="Напр.: ЖК «Северный» (корпус 3)">
          </div>

          <div class="row">
            <label for="address">Адрес *</label>
            <input id="address" required placeholder="Город, улица, дом, участок">
          </div>

          <div class="grid-2">
            <div class="row">
              <label for="start_date">Дата начала</label>
              <input id="start_date" type="date">
            </div>
            <div class="row">
              <label for="end_date">Дата окончания (план)</label>
              <input id="end_date" type="date">
            </div>
          </div>

          <div class="grid-2">
            <div class="row">
              <label for="customer">Заказчик</label>
              <input id="customer" placeholder="Компания-заказчик">
            </div>
            <div class="row">
              <label for="contractor">Генподрядчик / Подрядчик</label>
              <input id="contractor" placeholder="Компания-подрядчик">
            </div>
          </div>

          <div class="grid-2">
            <div class="row">
              <label for="manager_name">Ответственный (ФИО)</label>
              <input id="manager_name" placeholder="ФИО ответственного на объекте">
            </div>
            <div class="row">
              <label for="manager_contacts">Контакты ответственного</label>
              <input id="manager_contacts" placeholder="+7…, email…">
            </div>
          </div>

          <div class="grid-2">
            <div class="row">
              <label for="budget">Бюджет (₽)</label>
              <input id="budget" type="number" step="0.01" inputmode="decimal" placeholder="Напр.: 25000000">
            </div>
            <div class="row">
              <label for="status">Статус</label>
              <select id="status">
                <option value="активен">Активен</option>
                <option value="план">План</option>
                <option value="заморожен">Заморожен</option>
                <option value="закрыт">Закрыт</option>
              </select>
            </div>
          </div>

          <div class="row">
            <label for="code">Внутренний код</label>
            <input id="code" placeholder="Напр.: OBJ-2025-001">
          </div>

          <div class="row">
            <label for="description">Описание</label>
            <textarea id="description" placeholder="Краткое описание объекта, этапы, примечания"></textarea>
          </div>

          <div class="row">
            <label for="safety">Требования по безопасности</label>
            <textarea id="safety" placeholder="Инструктажи, допуски, СИЗ и т.п."></textarea>
          </div>

          <div class="row">
            <label for="attachments">Вложения (ссылки, примечания)</label>
            <textarea id="attachments" placeholder="Ссылки на документы / примечания к вложениям"></textarea>
          </div>

          <div class="hint" id="auditInfo"></div>

          <div class="inline">
            <button class="btn primary" type="submit" id="saveBtn">Сохранить изменения</button>
            <button class="btn" type="button" id="resetBtn">Сбросить изменения</button>
          </div>
          <div id="ok" class="ok"></div>
          <div id="err" class="err"></div>
        </form>
      </section>
    </div>
  </div>

  <script type="module">
    import supabase, { requireSession } from "./supabaseClient.js";
    import { invalidateCachePrefix } from "./cache.js";
    const headerReady = window.headerReady || Promise.resolve();

    const params = new URLSearchParams(location.search);
    const objectId = params.get("id");

    const form = document.getElementById("objectForm");
    const okBox = document.getElementById("ok");
    const errBox = document.getElementById("err");
    const pageTitle = document.getElementById("pageTitle");
    const viewBtn = document.getElementById("viewBtn");
    const auditInfo = document.getElementById("auditInfo");
    const saveBtn = document.getElementById("saveBtn");
    const resetBtn = document.getElementById("resetBtn");

    const field = id => document.getElementById(id);

    let originalData = null;

    function clearMessages(){
      okBox.style.display = "none";
      errBox.style.display = "none";
      okBox.textContent = "";
      errBox.textContent = "";
    }

    function parseBudget(value){
      if (value === null || value === undefined || value === "") return null;
      const normalized = value.toString().replace(/\s+/g, "").replace(",", ".");
      const num = Number(normalized);
      return Number.isFinite(num) ? num : null;
    }

    function toDateInput(value){
      if (!value) return "";
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) return "";
      return date.toISOString().slice(0, 10);
    }

    function fillForm(data){
      field("title").value = data.title || "";
      field("address").value = data.address || "";
      field("start_date").value = toDateInput(data.start_date);
      field("end_date").value = toDateInput(data.end_date);
      field("customer").value = data.customer || "";
      field("contractor").value = data.contractor || "";
      field("manager_name").value = data.manager_name || "";
      field("manager_contacts").value = data.manager_contacts || "";
      field("budget").value = data.budget ?? "";
      field("status").value = data.status || "активен";
      field("code").value = data.code || "";
      field("description").value = data.description || "";
      field("safety").value = data.safety || "";
      field("attachments").value = data.attachments?.text || "";
    }

    await headerReady;
    await requireSession({ redirectTo: "./index.html" });

    if (!objectId){
      pageTitle.textContent = "Объект не найден";
      form.remove();
      const card = document.querySelector(".card");
      card.insertAdjacentHTML("beforeend", '<div class="err" style="display:block">Не передан идентификатор объекта.</div>');
      viewBtn.remove();
    } else {
      viewBtn.href = `./object-view.html?id=${encodeURIComponent(objectId)}`;

      const { data, error } = await supabase
        .from("objects")
        .select("id, title, address, status, code, start_date, end_date, customer, contractor, manager_name, manager_contacts, budget, description, safety, attachments, created_at")
        .eq("id", objectId)
        .maybeSingle();

      if (error || !data){
        console.error("[object-edit] load error", error);
        pageTitle.textContent = "Объект не найден";
        form.remove();
        const card = document.querySelector(".card");
        card.insertAdjacentHTML("beforeend", '<div class="err" style="display:block">Не удалось загрузить объект. Возможно, запись удалена.</div>');
        viewBtn.remove();
      } else {
        originalData = typeof structuredClone === "function" ? structuredClone(data) : JSON.parse(JSON.stringify(data));
        pageTitle.textContent = data.title || "(без названия)";
        auditInfo.textContent = [
          data.created_at ? `Создан: ${new Date(data.created_at).toLocaleString("ru-RU")}` : "",
          data.updated_at ? `Обновлён: ${new Date(data.updated_at).toLocaleString("ru-RU")}` : ""
        ].filter(Boolean).join(" · ");
        fillForm(data);

        resetBtn.addEventListener("click", ()=>{
          fillForm(originalData);
          clearMessages();
        });

        form.addEventListener("submit", async evt=>{
          evt.preventDefault();
          clearMessages();

          const title = (field("title").value || "").trim();
          const address = (field("address").value || "").trim();
          if (!title || !address){
            errBox.textContent = "Заполните обязательные поля: Название и Адрес.";
            errBox.style.display = "block";
            return;
          }

          const attachmentsText = (field("attachments").value || "").trim();
          const existingFiles = originalData?.attachments?.files;
          let attachmentsPayload = null;
          if (attachmentsText){
            attachmentsPayload = {};
            if (Array.isArray(existingFiles) && existingFiles.length){
              attachmentsPayload.files = existingFiles;
            }
            attachmentsPayload.text = attachmentsText;
          } else if (Array.isArray(existingFiles) && existingFiles.length){
            attachmentsPayload = { files: existingFiles };
          }

          const payload = {
            title,
            address,
            start_date: field("start_date").value || null,
            end_date: field("end_date").value || null,
            customer: (field("customer").value || "").trim() || null,
            contractor: (field("contractor").value || "").trim() || null,
            manager_name: (field("manager_name").value || "").trim() || null,
            manager_contacts: (field("manager_contacts").value || "").trim() || null,
            budget: parseBudget(field("budget").value),
            status: field("status").value || "активен",
            code: (field("code").value || "").trim() || null,
            description: (field("description").value || "").trim() || null,
            safety: (field("safety").value || "").trim() || null,
            attachments: attachmentsPayload
          };

          saveBtn.disabled = true;
          saveBtn.textContent = "Сохраняем…";

          try{
            const { error: updateError } = await supabase
              .from("objects")
              .update(payload)
              .eq("id", objectId);
            if (updateError) throw updateError;

            okBox.textContent = "Изменения сохранены.";
            okBox.style.display = "block";
            pageTitle.textContent = title;
            originalData = { ...originalData, ...payload, title, address };
            originalData.attachments = attachmentsPayload;
            const updatedAt = new Date().toISOString();
            originalData.updated_at = updatedAt;
            auditInfo.textContent = [
              originalData.created_at ? `Создан: ${new Date(originalData.created_at).toLocaleString("ru-RU")}` : "",
              `Обновлён: ${new Date(updatedAt).toLocaleString("ru-RU")}`
            ].filter(Boolean).join(" · ");
            invalidateCachePrefix("objects:");
          }catch(ex){
            console.error("[object-edit] update error", ex);
            errBox.textContent = ex?.message || "Не удалось сохранить изменения.";
            errBox.style.display = "block";
          }finally{
            saveBtn.disabled = false;
            saveBtn.textContent = "Сохранить изменения";
          }
        });
      }
    }
  </script>
</body>
</html>
