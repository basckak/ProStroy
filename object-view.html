<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ProStroy — Объект</title>
  <meta name="color-scheme" content="dark">
  <link rel="stylesheet" href="assets/styles/base.css">
  <link rel="stylesheet" href="assets/styles/header.css">
  <style>
    :root{
      --bg:#0b1220; --panel:#0e172a; --panel2:#0b1320;
      --text:#eef3f9; --muted:#a9b4c7;
      --green:#22c55e; --green-2:#1ed760;
      --border:rgba(255,255,255,.12); --shadow:0 18px 60px rgba(0,0,0,.45);
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    video.bg{position:fixed;inset:0;width:100%;height:100%;object-fit:cover;z-index:-2;filter:brightness(.7)}

    .wrap{min-height:100%;padding:24px}
    .page{max-width:1100px;margin:0 auto;display:grid;gap:20px}
    .card{background:rgba(0,0,0,.55);border:1px solid var(--border);border-radius:var(--radius);
      box-shadow:var(--shadow);backdrop-filter:blur(6px);padding:18px}
    h1,h2{margin:0 0 10px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .kv{display:grid;grid-template-columns:220px 1fr;gap:10px;padding:8px 0;border-top:1px dashed rgba(255,255,255,.08)}
    .kv:first-of-type{border-top:none}
    .note{white-space:pre-wrap}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--border);font-size:.82rem}
    .line{height:1px;background:rgba(255,255,255,.08);margin:12px 0}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:980px){
      .kv{grid-template-columns:170px 1fr}
      .grid-2{grid-template-columns:1fr}
    }

    /* зелёные кнопки в твоём стиле */
    .btn-action {
      background:#22c55e;
      color:#000;
      font-weight:700;
      border:none;
      border-radius:12px;
      padding:10px 18px;
      cursor:pointer;
      text-decoration:none;
      display:inline-block;
      transition:background .2s ease, transform .06s ease;
    }
    .btn-action:hover{ background:#1ed760 }
    .btn-action:active{ transform:translateY(1px) }
    .btn-ghost{ background:transparent; color:#eef3f9; border:1px solid var(--border); border-radius:12px; padding:10px 18px; text-decoration:none }

  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js" defer></script>
  <script src="/js/supabaseClient.js" defer></script>
  <script src="/header.js" defer></script>
</head>
<body>
  <!-- фон-видео -->
  <video class="bg" autoplay muted loop playsinline preload="auto">
    <source src="https://assets.mixkit.co/videos/30431/30431-720.mp4" type="video/mp4">
  </video>

  <!-- общий header -->
  <div id="header"></div>

  <div class="wrap">
    <div class="page">

      <!-- Заголовок и быстрые действия -->
      <section class="card">
        <div class="flex-between">
          <div>
            <h1 id="obj-title">Объект</h1>
            <div class="muted">
              Код: <span id="obj-code" class="mono">—</span> ·
              Статус: <span id="obj-status" class="badge">—</span> ·
              Создан: <span id="obj-created">—</span>
            </div>
          </div>
          <div class="flex-row">
            <a class="btn-action" href="./objects-list.html">Открыть список</a>
            <a class="btn-action" id="editBtn" href="./object-edit.html">Редактировать</a>
            <a class="btn-action" href="./objects.html#new">Создать новый</a>
          </div>
        </div>
      </section>

      <!-- Основные данные -->
      <section class="card">
        <h2>Информация об объекте</h2>

        <div class="kv"><div class="muted">Адрес</div><div id="obj-address">—</div></div>

        <div class="grid-2">
          <div>
            <div class="kv"><div class="muted">Дата начала</div><div id="obj-start">—</div></div>
            <div class="kv"><div class="muted">Дата окончания</div><div id="obj-end">—</div></div>
            <div class="kv"><div class="muted">Заказчик</div><div id="obj-customer">—</div></div>
            <div class="kv"><div class="muted">Подрядчик</div><div id="obj-contractor">—</div></div>
          </div>
          <div>
            <div class="kv"><div class="muted">Ответственный</div><div id="obj-manager">—</div></div>
            <div class="kv"><div class="muted">Контакты</div><div id="obj-contacts">—</div></div>
            <div class="kv"><div class="muted">Бюджет</div><div id="obj-budget">—</div></div>
          </div>
        </div>

        <div class="kv"><div class="muted">Описание</div><div id="obj-desc" class="note">—</div></div>
        <div class="kv"><div class="muted">Безопасность</div><div id="obj-safety" class="note">—</div></div>
        <div class="kv"><div class="muted">Вложения</div><div id="obj-files" class="note">—</div></div>
      </section>

      <!-- Место под дальнейшие блоки (привязанные заявки, документы и т.п.) -->
      <!-- Пока оставим, позже добавим связку с заявками транспорт/материалы по object_id -->
      <!-- <section class="card"><h2>Связанные заявки</h2> ... </section> -->

    </div>
  </div>

  <script type="module">
        import supabase, { requireSession } from "./supabaseClient.js";
        const headerReady = window.headerReady || Promise.resolve();

    await headerReady;

    // Проверка авторизации
    const { data:{ session } } = await supabase.auth.getSession();
    if (!session){ location.replace("./index.html"); throw new Error("no auth"); }

    // Получим id из адресной строки
    const id = new URLSearchParams(location.search).get("id");
    const editBtn = document.getElementById("editBtn");
    if (!id){
      alert("Не передан id объекта (?id=...)");
      location.replace("./objects-list.html");
    }
    if (editBtn && id){
      editBtn.href = `./object-edit.html?id=${encodeURIComponent(id)}`;
    }

    const byId = (x)=>document.getElementById(x);
    const fmtDate = (d)=> d ? new Date(d).toLocaleDateString() : "—";
    const money = (n)=> (n==null || n==="") ? "—" : `${Number(n).toLocaleString('ru-RU')} ₽`;

    // Загрузим объект
    async function loadObject(){
      const { data, error } = await supabase
        .from("objects")
        .select("id, title, code, status, address, start_date, end_date, customer, contractor, manager_name, manager_contacts, budget, description, safety, attachments, created_at")
        .eq("id", id)
        .maybeSingle();

      if (error) {
        alert(error.message || "Ошибка загрузки объекта");
        location.replace("./objects-list.html");
        return;
      }
      if (!data){
        alert("Объект не найден или нет доступа.");
        location.replace("./objects-list.html");
        return;
      }

      // Заполним карточку
      byId("obj-title").textContent   = data.title || "Объект";
      byId("obj-code").textContent    = data.code || "—";
      byId("obj-status").textContent  = data.status || "—";
      byId("obj-created").textContent = data.created_at ? new Date(data.created_at).toLocaleString() : "—";

      byId("obj-address").textContent = data.address || "—";
      byId("obj-start").textContent   = fmtDate(data.start_date);
      byId("obj-end").textContent     = fmtDate(data.end_date);
      byId("obj-customer").textContent   = data.customer || "—";
      byId("obj-contractor").textContent = data.contractor || "—";
      byId("obj-manager").textContent    = data.manager_name || "—";
      byId("obj-contacts").textContent   = data.manager_contacts || "—";
      byId("obj-budget").textContent     = money(data.budget);
      byId("obj-desc").textContent       = data.description || "—";
      byId("obj-safety").textContent     = data.safety || "—";
      byId("obj-files").textContent      = data.attachments?.text || "—";
    }

    await loadObject();

    // если сессия протухнет — редирект
    supabase.auth.onAuthStateChange((_evt, s)=>{ if(!s) location.replace("./index.html"); });
  </script>
</body>
</html>
