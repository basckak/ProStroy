<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ProStroy — Объекты</title>
  <meta name="color-scheme" content="dark">
  <link rel="stylesheet" href="assets/styles/base.css">
  <link rel="stylesheet" href="assets/styles/header.css">
  <style>
    :root{
      --surface:rgba(6,10,18,.58);
      --border-soft:rgba(255,255,255,.12);
      --accent:#22c55e;
    }
    body{margin:0;min-height:100dvh;background:var(--bg,#0b1220);color:var(--text,#eef3f9);font-family:var(--font-sans,system-ui,-apple-system,"Segoe UI",Roboto,Inter,Arial);overflow-y:scroll}
    video.bg{position:fixed;inset:0;width:100%;height:100%;object-fit:cover;z-index:-2;filter:brightness(.72)}
    .overlay{position:fixed;inset:0;z-index:-1;background:linear-gradient(180deg,rgba(5,8,13,.2),rgba(5,8,13,.72))}
    .wrap{padding:20px}
    .page{max-width:1200px;margin:0 auto;display:grid;gap:18px}
    .card{background:var(--surface);border:1px solid var(--border-soft);border-radius:18px;padding:18px 22px;backdrop-filter:blur(10px);box-shadow:0 18px 40px rgba(0,0,0,.42)}
    .obj-head{display:flex;justify-content:space-between;align-items:center;gap:16px;flex-wrap:wrap}
    .obj-head > div{flex:1 1 320px}
    .obj-head .btn{flex-shrink:0}
    p.sub{margin:4px 0 0;color:var(--muted,#a9b4c7)}
    .filters{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .filters input,.filters select{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.18);border-radius:12px;padding:10px 14px;color:inherit;font:inherit;min-width:180px}
    .filters input{text-transform:none;flex:1 1 260px}
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:10px 16px;border-radius:12px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.08);color:inherit;font-weight:600;cursor:pointer;transition:filter .2s ease,border-color .2s ease;text-decoration:none}
    .btn:hover{filter:brightness(1.05);border-color:rgba(255,255,255,.28)}
    .btn.ghost{background:transparent}
    .btn.action{background:#22c55e;border:0;color:#0b1b14;box-shadow:0 10px 24px rgba(34,197,94,.18)}
    .btn.sm{padding:6px 10px;font-size:.85rem;border-radius:10px}
    .table-wrap{overflow-x:auto}
    table.obj-table{width:100%;border-collapse:collapse;font-size:.95rem;min-width:720px}
    table.obj-table thead{background:rgba(255,255,255,.06)}
    table.obj-table th,table.obj-table td{padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.08);text-align:left;vertical-align:top}
    table.obj-table td .muted{display:block;margin-top:4px;font-size:.8rem;color:var(--muted)}
    .status-badge{display:inline-flex;align-items:center;gap:6px;padding:4px 12px;border-radius:999px;font-size:.78rem;font-weight:600;border:1px solid transparent}
    .status-active{background:rgba(34,197,94,.18);color:#86efac;border-color:rgba(34,197,94,.32)}
    .status-plan{background:rgba(250,204,21,.18);color:#fde68a;border-color:rgba(250,204,21,.3)}
    .status-frozen{background:rgba(56,189,248,.18);color:#bae6fd;border-color:rgba(56,189,248,.3)}
    .status-closed{background:rgba(244,114,182,.18);color:#fbcfe8;border-color:rgba(244,114,182,.32)}
    .status-default{background:rgba(148,163,184,.18);color:#e2e8f0;border-color:rgba(148,163,184,.32)}
    table.obj-table td.actions{display:flex;gap:8px;flex-wrap:wrap}
    .table-footer{display:flex;justify-content:flex-end;margin-top:12px}
    .empty-state{padding:30px;text-align:center;color:var(--muted)}
    .loader{padding:24px;text-align:center;color:var(--muted)}
    @media(max-width:900px){
      .wrap{padding:16px}
      table.obj-table{font-size:.9rem}
      table.obj-table thead{display:none}
      table.obj-table{min-width:0}
      table.obj-table tbody tr{display:grid;border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:12px;margin-bottom:12px}
      table.obj-table td{border:0;padding:6px 0}
      table.obj-table td[data-label]:before{content:attr(data-label)": ";color:var(--muted);font-size:.82rem;display:block;margin-bottom:2px}
      .table-wrap{overflow:visible}
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js" defer></script>
  <script src="/js/supabaseClient.js" defer></script>
  <script src="/header.js" defer></script>
</head>
<body>
  <video class="bg" autoplay muted loop playsinline preload="auto">
    <source src="https://assets.mixkit.co/videos/30431/30431-720.mp4" type="video/mp4">
  </video>
  <div class="overlay"></div>
  <div id="header"></div>

  <div class="wrap">
    <div class="page">
      <section class="card obj-head">
        <div>
          <h1>Объекты</h1>
          <p class="sub">Единый список объектов компании с фильтрами и быстрым переходом к карточке.</p>
        </div>
        <a class="btn action" href="./objects.html#new">+ Новый объект</a>
      </section>

      <section class="card">
        <form id="filters" class="filters" autocomplete="off">
          <input id="q" placeholder="Поиск: название, адрес, код, заказчик…">
          <select id="status">
            <option value="">Статус: любой</option>
            <option value="активен">Активен</option>
            <option value="план">План</option>
            <option value="заморожен">Заморожен</option>
            <option value="закрыт">Закрыт</option>
          </select>
          <input id="from" type="date" aria-label="С даты">
          <input id="to" type="date" aria-label="По дату">
          <select id="sort">
            <option value="created_desc">Сначала новые</option>
            <option value="created_asc">Сначала старые</option>
            <option value="start_desc">Начало ↓</option>
            <option value="start_asc">Начало ↑</option>
          </select>
          <button class="btn ghost" type="button" id="btn-reset">Сброс</button>
          <button class="btn" type="submit">Применить</button>
        </form>
      </section>

      <section class="card">
        <div id="objectsContainer" class="table-wrap">
          <div class="loader">Загрузка объектов…</div>
        </div>
        <div class="table-footer is-hidden" id="moreWrap">
          <button id="btnMore" class="btn ghost sm">Показать ещё</button>
        </div>
      </section>
    </div>
  </div>

  <script type="module">
    import supabase, { requireSession } from "./supabaseClient.js";
    import { cachedFetch } from "./cache.js";
    const headerReady = window.headerReady || Promise.resolve();

    await headerReady;
    const { data:{ session } } = await supabase.auth.getSession();
    if (!session){ location.replace("./index.html"); throw new Error("no auth"); }

    const STATUS_BADGES = {
      "активен": { label: "Активен", class: "status-active" },
      "план": { label: "План", class: "status-plan" },
      "заморожен": { label: "Заморожен", class: "status-frozen" },
      "закрыт": { label: "Закрыт", class: "status-closed" }
    };

    const pageSize = 20;
    let offset = 0;
    let lastPage = false;

    const byId = id => document.getElementById(id);
    const container = byId("objectsContainer");
    const moreWrap = byId("moreWrap");
    const btnMore = byId("btnMore");
    const filters = {
      q: byId("q"),
      status: byId("status"),
      from: byId("from"),
      to: byId("to"),
      sort: byId("sort")
    };

    function escapeHtml(value){
      return String(value ?? "—").replace(/[&<>"']/g, ch => ({
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
        "'": "&#39;"
      })[ch] || ch);
    }

    function formatDate(value){
      if (!value) return "—";
      const dt = new Date(value);
      return Number.isNaN(dt.getTime()) ? "—" : dt.toLocaleDateString('ru-RU');
    }

    function formatPeriod(start, end){
      const s = formatDate(start);
      const e = formatDate(end);
      if (s === "—" && e === "—") return "—";
      if (e === "—") return `с ${s}`;
      if (s === "—") return `по ${e}`;
      return `${s} — ${e}`;
    }

    function formatBudget(value){
      if (value === null || value === undefined || value === "") return "—";
      return `${Number(value).toLocaleString('ru-RU')} ₽`;
    }

    function renderEmpty(message){
      container.innerHTML = `<div class="empty-state">${escapeHtml(message)}</div>`;
      moreWrap.classList.add("is-hidden");
    }

    function ensureTable(reset){
      if (reset || !container.querySelector("table")){
        container.innerHTML = `
          <table class="obj-table">
            <thead>
              <tr>
                <th>Название / Код</th>
                <th>Адрес</th>
                <th>Статус</th>
                <th>Период</th>
                <th>Заказчик</th>
                <th>Подрядчик</th>
                <th>Бюджет</th>
                <th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>`;
      }
      return container.querySelector("tbody");
    }

    function renderRows(rows, reset){
      const tbody = ensureTable(reset);
      if (reset) tbody.innerHTML = "";
      const frag = document.createDocumentFragment();
      rows.forEach(row => {
        const statusKey = (row.status || "").toLowerCase();
        const statusInfo = STATUS_BADGES[statusKey] || { label: row.status || "—", class: "status-default" };
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td data-label="Название / Код">
            <div>${escapeHtml(row.title)}</div>
            <div class="muted">${escapeHtml(row.code || "")}</div>
          </td>
          <td data-label="Адрес">${escapeHtml(row.address || "—")}</td>
          <td data-label="Статус"><span class="status-badge ${statusInfo.class}">${escapeHtml(statusInfo.label)}</span></td>
          <td data-label="Период">${escapeHtml(formatPeriod(row.start_date, row.end_date))}</td>
          <td data-label="Заказчик">${escapeHtml(row.customer || "—")}</td>
          <td data-label="Подрядчик">${escapeHtml(row.contractor || "—")}</td>
          <td data-label="Бюджет">${escapeHtml(formatBudget(row.budget))}</td>
          <td data-label="Действия" class="actions">
            <a class="btn ghost sm" href="./object-view.html?id=${encodeURIComponent(row.id)}">Открыть</a>
            <a class="btn ghost sm" href="./object-edit.html?id=${encodeURIComponent(row.id)}">Редактировать</a>
          </td>
        `;
        frag.appendChild(tr);
      });
      tbody.appendChild(frag);
    }

    async function loadObjects(reset=false){
      if (reset){
        offset = 0;
        lastPage = false;
        container.innerHTML = '<div class="loader">Загрузка объектов…</div>';
        moreWrap.classList.add("is-hidden");
      }

      let query = supabase
        .from("objects")
        .select("id, title, address, status, code, start_date, end_date, customer, contractor, budget, created_at", { count: "exact" });

      const text = (filters.q.value || "").trim();
      if (text){
        const like = `%${text.replace(/%/g, "")}%`;
        query = query.or([
          `title.ilike.${like}`,
          `address.ilike.${like}`,
          `code.ilike.${like}`,
          `customer.ilike.${like}`,
          `contractor.ilike.${like}`
        ].join(","));
      }

      if (filters.status.value){
        query = query.eq("status", filters.status.value);
      }

      if (filters.from.value){ query = query.gte("start_date", filters.from.value); }
      if (filters.to.value){ query = query.lte("start_date", filters.to.value); }

      const sort = filters.sort.value;
      if (sort === "created_asc"){
        query = query.order("created_at", { ascending: true });
      } else if (sort === "start_desc"){
        query = query.order("start_date", { ascending:false, nullsFirst:true }).order("created_at", { ascending:false });
      } else if (sort === "start_asc"){
        query = query.order("start_date", { ascending:true, nullsFirst:true }).order("created_at", { ascending:false });
      } else {
        query = query.order("created_at", { ascending:false });
      }

      query = query.range(offset, offset + pageSize - 1);

      const isDefaultFilters = !text && !filters.status.value && !filters.from.value && !filters.to.value && sort === "created_desc";

      const runQuery = async () => {
        const { data, error, count } = await query;
        if (error) throw error;
        return { data, count };
      };

      let result;
      try{
        if (reset && offset === 0 && isDefaultFilters){
          result = await cachedFetch("objects:list:default", runQuery, { ttlMs: 90000 });
        } else {
          result = await runQuery();
        }
      }catch(error){
        renderEmpty(`Ошибка загрузки: ${escapeHtml(error.message)}`);
        return;
      }

      const rows = result.data || [];
      if (!rows.length && offset === 0){
        renderEmpty("Ничего не найдено.");
        return;
      }

      renderRows(rows, reset);

      offset += rows.length;
      const total = typeof result.count === "number" ? result.count : offset;
      lastPage = offset >= total;
      moreWrap.classList.toggle("is-hidden", lastPage);
    }

    document.getElementById("filters").addEventListener("submit", event => {
      event.preventDefault();
      loadObjects(true);
    });

    document.getElementById("btn-reset").addEventListener("click", () => {
      filters.q.value = "";
      filters.status.value = "";
      filters.from.value = "";
      filters.to.value = "";
      filters.sort.value = "created_desc";
      loadObjects(true);
    });

    btnMore.addEventListener("click", () => {
      if (!lastPage) loadObjects(false);
    });

    await requireSession({ redirectTo: "./index.html" });
    await loadObjects(true);

    supabase.auth.onAuthStateChange((_evt, s)=>{ if (!s) location.replace("./index.html"); });
  </script>
</body>
</html>
