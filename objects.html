<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ProStroy — Объекты</title>
  <meta name="color-scheme" content="dark">
  <link rel="stylesheet" href="assets/styles/base.css">
  <link rel="stylesheet" href="assets/styles/header.css">
  <style>
    :root{
      --bg:#0b1220; --panel:#0e172a; --panel2:#0b1320;
      --text:#eef3f9; --muted:#a9b4c7;
      --green:#22c55e; --green-2:#1ed760;
      --border:rgba(255,255,255,.12); --shadow:0 18px 60px rgba(0,0,0,.45);
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    video.bg{position:fixed;inset:0;width:100%;height:100%;object-fit:cover;z-index:-2;filter:brightness(.7)}
    .wrap{min-height:100%;padding:24px}
    .page{max-width:1100px;margin:0 auto;display:grid;gap:20px}
    .card{background:rgba(0,0,0,.55);border:1px solid var(--border);border-radius:var(--radius);
      box-shadow:var(--shadow);backdrop-filter:blur(6px);padding:18px}
    h1,h2{margin:0 0 12px}
    .row{display:grid;gap:6px;margin-bottom:14px}
    label{font-size:.92rem;color:#d7deea}
    input, textarea, select, button{
      font:inherit;color:inherit;background:rgba(255,255,255,.06);
      border:1px solid var(--border);border-radius:12px;padding:10px 12px;outline:none
    }
    input:focus, textarea:focus, select:focus{border-color:#3b4458}
    textarea{min-height:90px;resize:vertical}
    .btn{cursor:pointer}
    .btn-primary{background:linear-gradient(135deg,var(--green),var(--green-2)); color:#062915; font-weight:700; border:none}
    .ok,.err{display:none;margin-top:10px;padding:10px;border-radius:12px;font-size:.92rem}
    .ok{background:rgba(34,197,94,.12);border:1px solid rgba(34,197,94,.5);color:#b6ffd0}
    .err{background:rgba(255,122,122,.12);border:1px solid rgba(255,122,122,.35);color:#ffbdbd}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width:980px){ .grid-2{grid-template-columns:1fr} }

    .muted{color:var(--muted)}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js" defer></script>
  <script src="/js/supabaseClient.js" defer></script>
  <script src="/header.js" defer></script>
</head>
<body>
  <!-- фон-видео -->
  <video class="bg" autoplay muted loop playsinline preload="auto">
    <source src="https://assets.mixkit.co/videos/30431/30431-720.mp4" type="video/mp4">
  </video>

  <!-- общий header -->
  <div id="header"></div>

  <!-- контент -->
  <div class="wrap">
    <div class="page">
      <section id="new" class="card">
        <h1>Добавить новый объект</h1>
        <form id="objForm" autocomplete="on">
          <div class="row">
            <label for="title">Название объекта *</label>
            <input id="title" required placeholder="Напр.: ЖК «Северный» (корпус 3)">
          </div>

          <div class="row">
            <label for="address">Адрес *</label>
            <input id="address" required placeholder="Город, улица, дом, участок">
          </div>

          <div class="grid-2">
            <div class="row">
              <label for="start_date">Дата начала</label>
              <input id="start_date" type="date">
            </div>
            <div class="row">
              <label for="end_date">Дата окончания (план)</label>
              <input id="end_date" type="date">
            </div>
          </div>

          <div class="row">
            <label for="customer">Заказчик</label>
            <input id="customer" placeholder="Компания-заказчик">
          </div>

          <div class="row">
            <label for="contractor">Генподрядчик/Подрядчик</label>
            <input id="contractor" placeholder="Компания-подрядчик">
          </div>

          <div class="grid-2">
            <div class="row">
              <label for="manager_name">Ответственный (ФИО)</label>
              <input id="manager_name" placeholder="ФИО ответственного на объекте">
            </div>
            <div class="row">
              <label for="manager_contacts">Контакты ответственного</label>
              <input id="manager_contacts" placeholder="+7..., email...">
            </div>
          </div>

          <div class="row">
            <label for="budget">Бюджет (₽)</label>
            <input id="budget" type="number" step="0.01" placeholder="Напр.: 25000000">
          </div>

          <div class="row">
            <label for="description">Описание</label>
            <textarea id="description" placeholder="Краткое описание объекта, этапы, примечания"></textarea>
          </div>

          <div class="row">
            <label for="safety">Требования по безопасности</label>
            <textarea id="safety" placeholder="Инструктажи, допуски, СИЗ и т.п."></textarea>
          </div>

          <div class="row">
            <label for="attachments">Вложения</label>
            <textarea id="attachments" placeholder="Ссылки на документы / примечания к вложениям"></textarea>
          </div>

          <div class="grid-2">
            <div class="row">
              <label for="status">Статус</label>
              <select id="status">
                <option value="активен" selected>Активен</option>
                <option value="план">План</option>
                <option value="заморожен">Заморожен</option>
                <option value="закрыт">Закрыт</option>
              </select>
            </div>
            <div class="row">
              <label for="code">Внутренний код (необязательно)</label>
              <input id="code" placeholder="Напр.: OBJ-2025-001">
            </div>
          </div>

          <button class="btn btn-primary" type="submit">Создать объект</button>
          <div id="ok" class="ok">Объект создан.</div>
          <div id="err" class="err">Ошибка создания объекта.</div>
        </form>
      </section>
    </div>
  </div>

  <!-- скрипты -->
  <script type="module">
        import supabase, { requireSession } from "./supabaseClient.js";
    import { invalidateCachePrefix } from "./cache.js";
    const headerReady = window.headerReady || Promise.resolve();

    // Загружаем общий хедер
    await headerReady;

    // Авторизация обязательна
    const { data:{ session } } = await supabase.auth.getSession();
    if (!session){ location.replace("./index.html"); throw new Error("no auth"); }
    const user = session.user;

    // ===== Форма создания объекта
    const byId = (id)=>document.getElementById(id);
    const readText = (id)=> (byId(id).value || "").trim();
    function parseNum(v){ const n = Number((v||"").toString().replace(",", ".")); return Number.isFinite(n) ? n : null; }

    document.getElementById("objForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const ok = byId("ok"), err = byId("err");
      ok.style.display="none"; err.style.display="none";

      const title = readText("title");
      const address = readText("address");
      if (!title || !address){
        err.textContent = "Заполните обязательные поля: Название и Адрес.";
        err.style.display = "block";
        return;
      }

      const payload = {
        user_id: user.id,                 // кто создал
        title,
        address,
        start_date: byId("start_date").value || null,
        end_date: byId("end_date").value || null,
        customer: readText("customer") || null,
        contractor: readText("contractor") || null,
        manager_name: readText("manager_name") || null,
        manager_contacts: readText("manager_contacts") || null,
        budget: parseNum(byId("budget").value),
        description: readText("description") || null,
        safety: readText("safety") || null,
        attachments: readText("attachments") ? { text: readText("attachments") } : null,
        status: byId("status").value || "активен",
        code: readText("code") || null
      };

      try{
        const { data, error } = await supabase
          .from("objects")
          .insert(payload)
          .select("id, title");
        if (error) throw error;
        const row = Array.isArray(data) ? data[0] : data;
        ok.textContent = `Объект «${row?.title || title}» создан.`;
        ok.style.display = "block";
        invalidateCachePrefix("objects:");
        e.target.reset();
        // плавно вверх
        window.scrollTo({ top: 0, behavior: "smooth" });
      }catch(ex){
        console.error(ex);
        err.textContent = ex.message || "Ошибка создания объекта.";
        err.style.display = "block";
      }
    });

    // на всякий случай: если сессия пропала — уводим на логин
    supabase.auth.onAuthStateChange((_evt, s)=>{ if(!s) location.replace("./index.html"); });
  </script>
</body>
</html>
