<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ProStroy — Фотоотчёт по объекту</title>
  <meta name="color-scheme" content="dark">
  <link rel="stylesheet" href="assets/styles/base.css">
  <link rel="stylesheet" href="assets/styles/header.css">
  <style>
    :root{
      --surface:rgba(6,10,18,.58);
      --border-soft:rgba(148,163,184,.2);
      --muted:rgba(191,219,254,.72);
      --card-shadow:0 24px 48px rgba(6,12,24,.42);
    }
    body{
      margin:0;
      min-height:100dvh;
      background:var(--bg,#0b1220);
      color:var(--text,#eef3f9);
      font-family:var(--font-sans,system-ui,-apple-system,"Segoe UI",Roboto,Inter,Arial);
      overflow-y:scroll;
    }
    video.bg{
      position:fixed;
      inset:0;
      width:100%;
      height:100%;
      object-fit:cover;
      z-index:-2;
      filter:brightness(.72);
    }
    .overlay{
      position:fixed;
      inset:0;
      z-index:-1;
      background:linear-gradient(185deg,rgba(5,8,13,.18),rgba(5,8,13,.78));
    }
    .wrap{
      padding:24px;
    }
    .page{
      max-width:1280px;
      margin:0 auto;
      display:grid;
      gap:22px;
    }
    .card{
      background:var(--surface);
      border:1px solid var(--border-soft);
      border-radius:22px;
      padding:24px 26px;
      backdrop-filter:blur(14px);
      box-shadow:var(--card-shadow);
    }
    .card h1{
      margin:6px 0 10px;
      font-size:1.9rem;
    }
    .card p.sub{
      margin:0;
      color:var(--muted);
    }
    .breadcrumbs{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:8px;
      font-size:.9rem;
      color:var(--muted);
    }
    .breadcrumbs a{
      color:inherit;
      text-decoration:none;
    }
    .breadcrumbs a:hover{
      text-decoration:underline;
    }
    .filters{
      display:flex;
      flex-wrap:wrap;
      gap:14px;
      align-items:center;
    }
    .filters input{
      min-width:200px;
      padding:10px 14px;
      border-radius:14px;
      border:1px solid rgba(148,163,184,.24);
      background:rgba(255,255,255,.06);
      color:inherit;
      font:inherit;
    }
    .filters button{
      padding:10px 16px;
      border-radius:14px;
      border:1px solid rgba(148,163,184,.26);
      background:rgba(255,255,255,.08);
      color:inherit;
      font-weight:600;
      cursor:pointer;
      transition:filter .2s ease,border-color .2s ease;
    }
    .filters button:hover{
      filter:brightness(1.05);
      border-color:rgba(148,163,184,.4);
    }
    .buttons{
      display:flex;
      flex-wrap:wrap;
      gap:12px;
    }
    .btn-primary{
      background:linear-gradient(135deg,#22c55e,#1ed760);
      border:0;
      color:#062915;
      box-shadow:0 16px 36px rgba(34,197,94,.18);
    }
    .session-grid{
      display:grid;
      gap:18px;
      grid-template-columns:repeat(1,minmax(0,1fr));
    }
    @media(min-width:720px){
      .session-grid{grid-template-columns:repeat(2,minmax(0,1fr));}
    }
    @media(min-width:1080px){
      .session-grid{grid-template-columns:repeat(3,minmax(0,1fr));}
    }
    @media(min-width:1360px){
      .session-grid{grid-template-columns:repeat(4,minmax(0,1fr));}
    }
    .session-card{
      position:relative;
      display:flex;
      flex-direction:column;
      border-radius:18px;
      overflow:hidden;
      border:1px solid rgba(148,163,184,.22);
      background:rgba(14,23,42,.74);
      transition:transform .18s ease,border-color .2s ease,box-shadow .2s ease;
      text-decoration:none;
      color:inherit;
    }
    .session-card:hover{
      transform:translateY(-3px);
      border-color:rgba(148,163,184,.32);
      box-shadow:0 28px 52px rgba(8,16,28,.46);
    }
    .session-card__cover{
      width:100%;
      aspect-ratio:16/10;
      background:linear-gradient(135deg,rgba(37,99,235,.28),rgba(56,189,248,.24));
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .session-card__cover img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .session-card__placeholder{
      font-size:.88rem;
      color:rgba(226,232,240,.82);
      padding:0 12px;
      text-align:center;
    }
    .session-card__body{
      padding:18px 20px 20px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .session-card__title{
      margin:0;
      font-size:1.02rem;
      line-height:1.34;
    }
    .session-card__period{
      font-size:.9rem;
      color:var(--muted);
    }
    .session-card__footer{
      display:flex;
      justify-content:space-between;
      gap:12px;
      font-size:.88rem;
      color:rgba(226,232,240,.82);
    }
    form.session-form{
      display:grid;
      gap:18px;
    }
    form.session-form .row{
      display:grid;
      gap:12px;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
    }
    form.session-form label{
      display:grid;
      gap:6px;
      font-size:.92rem;
      color:#d7deea;
    }
    form.session-form input,
    form.session-form textarea{
      padding:11px 14px;
      border-radius:14px;
      border:1px solid rgba(148,163,184,.24);
      background:rgba(255,255,255,.06);
      color:inherit;
      font:inherit;
    }
    form.session-form input[type="file"]{
      padding:8px;
      background:transparent;
      border:dashed 1px rgba(148,163,184,.32);
    }
    .form-actions{
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      justify-content:flex-end;
    }
    .note{
      font-size:.9rem;
      color:var(--muted);
    }
    .status-line{
      font-size:.92rem;
      color:var(--muted);
    }
    .status-line.err{
      color:#fecaca;
    }
    .status-line.ok{
      color:#bbf7d0;
    }
    .loader,
    .empty-state{
      padding:24px;
      text-align:center;
      color:var(--muted);
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js" defer></script>
  <script src="/js/supabaseClient.js" defer></script>
  <script src="/header.js" defer></script>
</head>
<body>
  <video class="bg" autoplay muted loop playsinline preload="auto">
    <source src="https://assets.mixkit.co/videos/30431/30431-720.mp4" type="video/mp4">
  </video>
  <div class="overlay"></div>

  <div id="header-mount">
    <div id="header"></div>
  </div>

  <div class="wrap">
    <div class="page">
      <section class="card">
        <nav class="breadcrumbs">
          <a href="./photo-reports.html">Фотоотчёт</a>
          <span>/</span>
          <span id="breadcrumbObject">Объект</span>
        </nav>
        <h1 id="pageTitle">Фотоотчёт</h1>
        <p class="sub" id="pageSubtitle">Загрузка данных об объекте…</p>
      </section>

      <section class="card">
        <div class="filters">
          <input type="month" id="filterPeriod" aria-label="Фильтр по месяцу">
          <input type="search" id="filterSearch" placeholder="Поиск по названию сессии" aria-label="Поиск">
          <div class="buttons">
            <button type="button" id="filterReset">Сбросить</button>
            <button type="button" id="toggleCreate" class="btn-primary">Новая сессия</button>
          </div>
        </div>
      </section>

      <section class="card" id="createCard" hidden>
        <form id="sessionForm" class="session-form" autocomplete="off">
          <div class="row">
            <label>
              Название сессии *
              <input id="sessionTitle" required placeholder="Напр.: Неделя 42. Фасад">
            </label>
            <label>
              Дата начала *
              <input id="sessionStart" type="date" required>
            </label>
            <label>
              Дата окончания
              <input id="sessionEnd" type="date">
            </label>
          </div>
          <label>
            Файлы *
            <input id="sessionFiles" type="file" accept="image/*,video/*" multiple required>
            <span class="note">Загрузите фотографии или видео. Названия будут пронумерованы автоматически.</span>
          </label>
          <div class="form-actions">
            <button type="button" id="cancelCreate">Отмена</button>
            <button type="submit" class="btn-primary" id="submitCreate">Создать сессию</button>
          </div>
          <div class="status-line" id="createStatus" hidden></div>
        </form>
      </section>

      <section class="card">
        <div id="sessionsContainer">
          <div class="loader">Загружаем сессии…</div>
        </div>
      </section>
    </div>
  </div>

  <script type="module">
    import { fetchObjectSummary, createSession, getPublicUrl } from "./js/photo-reports-api.js";

    const params = new URLSearchParams(location.search);
    const objectId = params.get("object");
    const breadcrumbObject = document.getElementById("breadcrumbObject");
    const pageTitle = document.getElementById("pageTitle");
    const pageSubtitle = document.getElementById("pageSubtitle");
    const sessionsContainer = document.getElementById("sessionsContainer");
    const filterPeriod = document.getElementById("filterPeriod");
    const filterSearch = document.getElementById("filterSearch");
    const filterReset = document.getElementById("filterReset");
    const toggleCreate = document.getElementById("toggleCreate");
    const createCard = document.getElementById("createCard");
    const cancelCreate = document.getElementById("cancelCreate");
    const sessionForm = document.getElementById("sessionForm");
    const sessionTitle = document.getElementById("sessionTitle");
    const sessionStart = document.getElementById("sessionStart");
    const sessionEnd = document.getElementById("sessionEnd");
    const sessionFiles = document.getElementById("sessionFiles");
    const createStatus = document.getElementById("createStatus");
    const submitCreate = document.getElementById("submitCreate");

    let allSessions = [];
    let currentObject = null;

    if (!objectId){
      sessionsContainer.innerHTML = '<div class="empty-state">Не указан идентификатор объекта (?object=ID).</div>';
      pageTitle.textContent = "Фотоотчёт";
      pageSubtitle.textContent = "Укажите объект в адресной строке.";
      throw new Error("Missing object id");
    }

    function formatPeriod(session){
      const start = session.period_start ? new Date(session.period_start) : null;
      const end = session.period_end ? new Date(session.period_end) : null;
      if (start && end){
        return `${start.toLocaleDateString("ru-RU")} — ${end.toLocaleDateString("ru-RU")}`;
      }
      if (start){
        return start.toLocaleDateString("ru-RU");
      }
      if (end){
        return end.toLocaleDateString("ru-RU");
      }
      return "Период не указан";
    }

    function formatDate(value){
      if (!value) return "—";
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) return "—";
      return date.toLocaleDateString("ru-RU");
    }

    function sessionMatchesPeriod(session, monthValue){
      if (!monthValue) return true;
      const [year, month] = monthValue.split("-").map(Number);
      if (!year || !month) return true;
      const start = new Date(year, month - 1, 1);
      const end = new Date(year, month, 0, 23, 59, 59, 999);
      const startDate = session.period_start ? new Date(session.period_start) : null;
      const endDate = session.period_end ? new Date(session.period_end) : null;
      if (startDate && endDate){
        return startDate <= end && endDate >= start;
      }
      const pivot = startDate || endDate || (session.last_update ? new Date(session.last_update) : null);
      if (!pivot) return true;
      return pivot >= start && pivot <= end;
    }

    function renderSessions(list){
      if (!list.length){
        sessionsContainer.innerHTML = '<div class="empty-state">Сессий пока нет.</div>';
        return;
      }
      const grid = document.createElement("div");
      grid.className = "session-grid";
      const fragment = document.createDocumentFragment();
      list.forEach((session)=>{
        const card = document.createElement("a");
        card.className = "session-card";
        card.href = `./photo-session.html?object=${encodeURIComponent(objectId)}&session=${encodeURIComponent(session.session_id)}`;
        card.setAttribute("aria-label", `Сессия ${session.title}`);

        const cover = document.createElement("div");
        cover.className = "session-card__cover";
        if (session.cover_path){
          const img = document.createElement("img");
          img.src = getPublicUrl(session.cover_path);
          img.alt = `Обложка сессии ${session.title}`;
          img.loading = "lazy";
          cover.appendChild(img);
        }else{
          const placeholder = document.createElement("div");
          placeholder.className = "session-card__placeholder";
          placeholder.textContent = "Фотографии не найдены";
          cover.appendChild(placeholder);
        }

        const body = document.createElement("div");
        body.className = "session-card__body";

        const title = document.createElement("h3");
        title.className = "session-card__title";
        title.textContent = session.title || session.session_id;

        const period = document.createElement("div");
        period.className = "session-card__period";
        period.textContent = formatPeriod(session);

        const footer = document.createElement("div");
        footer.className = "session-card__footer";
        footer.innerHTML = `<span>${session.count ?? 0} файлов</span><span>Обновлено ${formatDate(session.last_update)}</span>`;

        body.appendChild(title);
        body.appendChild(period);
        body.appendChild(footer);

        card.appendChild(cover);
        card.appendChild(body);
        fragment.appendChild(card);
      });

      grid.appendChild(fragment);
      sessionsContainer.innerHTML = "";
      sessionsContainer.appendChild(grid);
    }

    function applyFilters(){
      const term = filterSearch.value.trim().toLowerCase();
      const month = filterPeriod.value;
      const filtered = allSessions.filter((session)=>{
        const matchesTerm = !term || (session.title || "").toLowerCase().includes(term) || session.session_id.toLowerCase().includes(term);
        const matchesPeriod = sessionMatchesPeriod(session, month);
        return matchesTerm && matchesPeriod;
      });
      renderSessions(filtered);
    }

    async function loadObject(){
      const client = window.sb;
      if (!client){
        throw new Error("Supabase client не инициализирован.");
      }
      const { data, error } = await client
        .from("objects")
        .select("id, title, status, address")
        .eq("id", objectId)
        .maybeSingle();
      if (error) throw error;
      if (!data) throw new Error("Объект не найден.");
      currentObject = data;
      const title = data.title || `Объект ${data.id}`;
      pageTitle.textContent = title;
      breadcrumbObject.textContent = title;
      pageSubtitle.textContent = data.address ? `Адрес: ${data.address}` : "Адрес не указан.";
    }

    async function loadSessions(){
      sessionsContainer.innerHTML = '<div class="loader">Загружаем сессии…</div>';
      try{
        const summary = await fetchObjectSummary(objectId);
        allSessions = summary?.sessions || [];
        applyFilters();
      }catch(error){
        console.error("Не удалось загрузить сессии", error);
        sessionsContainer.innerHTML = '<div class="empty-state">Не удалось загрузить сессии. Попробуйте обновить страницу.</div>';
      }
    }

    function toggleCreateCard(force){
      const shouldShow = typeof force === "boolean" ? force : createCard.hasAttribute("hidden");
      if (shouldShow){
        createCard.removeAttribute("hidden");
        toggleCreate.textContent = "Скрыть форму";
        sessionTitle.focus();
      }else{
        createCard.setAttribute("hidden", "");
        toggleCreate.textContent = "Новая сессия";
        sessionForm.reset();
        createStatus.hidden = true;
      }
    }

    async function init(){
      await (window.headerReady || Promise.resolve());
      await loadObject().catch((error)=>{
        console.error(error);
        pageSubtitle.textContent = error.message || "Ошибка загрузки объекта.";
        sessionsContainer.innerHTML = '<div class="empty-state">Не удалось загрузить объект.</div>';
        throw error;
      });
      await loadSessions();
    }

    filterPeriod.addEventListener("change", applyFilters);
    filterSearch.addEventListener("input", applyFilters);
    filterReset.addEventListener("click", ()=>{
      filterPeriod.value = "";
      filterSearch.value = "";
      applyFilters();
    });

    toggleCreate.addEventListener("click", ()=> toggleCreateCard());
    cancelCreate.addEventListener("click", ()=> toggleCreateCard(false));

    sessionForm.addEventListener("submit", async (event)=>{
      event.preventDefault();
      createStatus.hidden = true;
      const files = Array.from(sessionFiles.files || []);
      if (!files.length){
        createStatus.textContent = "Выберите файлы для загрузки.";
        createStatus.className = "status-line err";
        createStatus.hidden = false;
        return;
      }

      submitCreate.disabled = true;
      toggleCreate.disabled = true;
      cancelCreate.disabled = true;
      createStatus.className = "status-line";
      createStatus.hidden = false;
      createStatus.textContent = "Загружаем…";

      try{
        await createSession(
          objectId,
          {
            title: sessionTitle.value.trim(),
            periodStart: sessionStart.value,
            periodEnd: sessionEnd.value || null,
            files
          },
          {
            onProgress: ({ uploaded, total })=>{
              createStatus.textContent = `Загрузка файлов: ${uploaded} / ${total}`;
            }
          }
        );
        createStatus.textContent = "Сессия успешно создана.";
        createStatus.className = "status-line ok";
        sessionForm.reset();
        await loadSessions();
      }catch(error){
        console.error("Ошибка создания сессии", error);
        createStatus.textContent = error.message || "Не удалось создать сессию.";
        createStatus.className = "status-line err";
      }finally{
        submitCreate.disabled = false;
        toggleCreate.disabled = false;
        cancelCreate.disabled = false;
      }
    });

    init().catch((error)=>{
      console.error("Инициализация страницы не удалась", error);
    });
  </script>
</body>
</html>
