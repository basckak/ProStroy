<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ProStroy — Фотоотчёт</title>
  <meta name="color-scheme" content="dark">
  <link rel="stylesheet" href="assets/styles/base.css">
  <link rel="stylesheet" href="assets/styles/header.css">
  <style>
    :root{
      --surface:rgba(6,10,18,.6);
      --border-soft:rgba(148,163,184,.22);
      --card-shadow:0 22px 48px rgba(6,12,24,.42);
      --muted:rgba(191,219,254,.72);
    }
    body{
      margin:0;
      min-height:100dvh;
      background:var(--bg,#0b1220);
      color:var(--text,#eef3f9);
      font-family:var(--font-sans,system-ui,-apple-system,"Segoe UI",Roboto,Inter,Arial);
      overflow-y:scroll;
    }
    video.bg{
      position:fixed;
      inset:0;
      width:100%;
      height:100%;
      object-fit:cover;
      z-index:-2;
      filter:brightness(.72);
    }
    .overlay{
      position:fixed;
      inset:0;
      z-index:-1;
      background:linear-gradient(185deg,rgba(5,8,13,.18),rgba(5,8,13,.78));
    }
    .wrap{
      padding:24px;
    }
    .page{
      max-width:1380px;
      margin:0 auto;
      display:grid;
      gap:22px;
    }
    .card{
      background:var(--surface);
      border:1px solid var(--border-soft);
      border-radius:22px;
      padding:24px 28px;
      backdrop-filter:blur(14px);
      box-shadow:var(--card-shadow);
    }
    .card h1{
      margin:0 0 8px;
      font-size:1.9rem;
    }
    .card p.sub{
      margin:0;
      color:var(--muted);
    }
    .photo-grid{
      display:grid;
      gap:18px;
      grid-template-columns:repeat(1,minmax(0,1fr));
    }
    @media(min-width:768px){
      .photo-grid{grid-template-columns:repeat(2,minmax(0,1fr));}
    }
    @media(min-width:1200px){
      .photo-grid{grid-template-columns:repeat(3,minmax(0,1fr));}
    }
    .photo-card{
      position:relative;
      display:flex;
      flex-direction:column;
      border-radius:20px;
      overflow:hidden;
      border:1px solid rgba(148,163,184,.18);
      background:rgba(15,23,42,.68);
      transition:transform .18s ease, border-color .2s ease, box-shadow .2s ease;
      text-decoration:none;
      color:inherit;
      min-height:100%;
    }
    .photo-card:hover{
      transform:translateY(-3px);
      border-color:rgba(148,163,184,.32);
      box-shadow:0 32px 60px rgba(6,12,24,.46);
    }
    .photo-card__cover{
      position:relative;
      width:100%;
      aspect-ratio:16/10;
      background:linear-gradient(135deg,rgba(30,64,175,.32),rgba(14,116,144,.28));
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      flex-shrink:0;
    }
    .photo-card__cover img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .photo-card__placeholder{
      font-size:.9rem;
      color:rgba(226,232,240,.78);
    }
    .photo-card__body{
      padding:18px 20px 20px;
      display:flex;
      flex-direction:column;
      gap:12px;
      flex:1 1 auto;
    }
    .photo-card__title{
      margin:0;
      font-size:1.05rem;
      line-height:1.35;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
      min-height:calc(1.35em * 2);
    }
    .photo-card__meta{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-top:auto;
    }
    .photo-card__row{
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-size:.92rem;
      color:rgba(226,232,240,.82);
    }
    .photo-card__row span:last-child{
      color:var(--muted);
    }
    .loader,
    .empty-state{
      padding:24px;
      text-align:center;
      color:var(--muted);
    }
    .status-badge{
      align-self:flex-start;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js" defer></script>
  <script src="/js/supabaseClient.js" defer></script>
  <script src="/header.js" defer></script>
</head>
<body>
  <video class="bg" autoplay muted loop playsinline preload="auto">
    <source src="https://assets.mixkit.co/videos/30431/30431-720.mp4" type="video/mp4">
  </video>
  <div class="overlay"></div>

  <div id="header-mount">
    <div id="header"></div>
  </div>

  <div class="wrap">
    <div class="page">
      <section class="card">
        <h1>Фотоотчёт</h1>
        <p class="sub">Активные объекты и их визуальный прогресс.</p>
      </section>

      <section class="card">
        <div id="reportsContainer">
          <div class="loader">Загружаем объекты…</div>
        </div>
      </section>
    </div>
  </div>

  <script type="module">
    import { fetchActiveObjects, fetchObjectSummary, getPublicUrl } from "./js/photo-reports-api.js";

    const STATUS_CLASS = {
      "активен": "status-active",
      "план": "status-plan",
      "заморожен": "status-frozen",
      "закрыт": "status-closed"
    };

    const container = document.getElementById("reportsContainer");

    function statusBadge(status){
      const normalized = (status || "").toLowerCase();
      const cls = STATUS_CLASS[normalized] || "status-other";
      const badge = document.createElement("span");
      badge.className = `status-badge ${cls}`;
      badge.textContent = status || "—";
      return badge;
    }

    function formatDate(value){
      if (!value) return "—";
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) return "—";
      return date.toLocaleDateString("ru-RU", { day: "2-digit", month: "long", year: "numeric" });
    }

    function renderEmpty(message){
      container.innerHTML = `<div class="empty-state">${message}</div>`;
    }

    async function renderReports(){
      container.innerHTML = `<div class="loader">Загружаем объекты…</div>`;
      try{
        await (window.headerReady || Promise.resolve());
        const objects = await fetchActiveObjects();
        if (!objects.length){
          renderEmpty("Активных объектов пока нет.");
          return;
        }

        const results = await Promise.all(objects.map(async (object)=>{
          try{
            const summary = await fetchObjectSummary(object.id);
            const sessions = summary?.sessions || [];
            const latest = sessions[0] || null;
            const coverUrl = latest?.cover_path ? getPublicUrl(latest.cover_path) : null;
            return {
              object,
              totalCount: summary?.total_count ?? sessions.reduce((sum, item)=>sum + (item.count || 0), 0),
              lastUpdate: latest?.last_update || summary?.updated_at || null,
              coverUrl,
              hasPhotos: (summary?.total_count ?? 0) > 0
            };
          }catch(error){
            console.error("Не удалось загрузить сессии объекта", object.id, error);
            return {
              object,
              totalCount: 0,
              lastUpdate: null,
              coverUrl: null,
              hasPhotos: false,
              error
            };
          }
        }));

        const grid = document.createElement("div");
        grid.className = "photo-grid";
        const fragment = document.createDocumentFragment();

        results.forEach((item)=>{
          const { object, totalCount, lastUpdate, coverUrl, hasPhotos } = item;
          const link = document.createElement("a");
          link.className = "photo-card";
          link.href = `./photo-object.html?object=${encodeURIComponent(object.id)}`;
          link.setAttribute("aria-label", `Фотоотчёт по объекту ${object.title}`);

          const cover = document.createElement("div");
          cover.className = "photo-card__cover";
          if (coverUrl){
            const img = document.createElement("img");
            img.src = coverUrl;
            img.alt = `Обложка объекта ${object.title}`;
            img.loading = "lazy";
            cover.appendChild(img);
          }else{
            const placeholder = document.createElement("div");
            placeholder.className = "photo-card__placeholder";
            placeholder.textContent = hasPhotos ? "Обложка не найдена" : "Фотографии отсутствуют";
            cover.appendChild(placeholder);
          }

          const body = document.createElement("div");
          body.className = "photo-card__body";

          const title = document.createElement("h3");
          title.className = "photo-card__title";
          title.textContent = object.title || "Без названия";

          const meta = document.createElement("div");
          meta.className = "photo-card__meta";
          meta.appendChild(statusBadge(object.status));

          const countRow = document.createElement("div");
          countRow.className = "photo-card__row";
          countRow.innerHTML = `<span>Файлов</span><span>${totalCount}</span>`;
          meta.appendChild(countRow);

          const dateRow = document.createElement("div");
          dateRow.className = "photo-card__row";
          dateRow.innerHTML = `<span>Последнее обновление</span><span>${formatDate(lastUpdate)}</span>`;
          meta.appendChild(dateRow);

          body.appendChild(title);
          body.appendChild(meta);

          link.appendChild(cover);
          link.appendChild(body);
          fragment.appendChild(link);
        });

        grid.appendChild(fragment);
        container.innerHTML = "";
        container.appendChild(grid);
      }catch(error){
        console.error("Ошибка загрузки фотоотчёта", error);
        renderEmpty("Не удалось загрузить список. Попробуйте обновить страницу.");
      }
    }

    renderReports();
  </script>
</body>
</html>
