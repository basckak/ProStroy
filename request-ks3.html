<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ProStroy — Справка КС-3</title>
  <meta name="color-scheme" content="dark">
  <link rel="stylesheet" href="assets/styles/base.css">
  <link rel="stylesheet" href="assets/styles/header.css">
  <link rel="stylesheet" href="assets/styles/contract-form.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js" defer></script>
  <script src="/js/supabaseClient.js" defer></script>
  <script src="/header.js" defer></script>
</head>
<body style="--bg-video-filter: brightness(0.7);">
  <video class="bg" autoplay muted loop playsinline preload="auto">
    <source src="https://assets.mixkit.co/videos/30431/30431-720.mp4" type="video/mp4">
  </video>

  <div id="header"></div>

  <div class="wrap">
    <div class="page">
      <section class="card">
        <h1>Справка КС-3</h1>
        <p>Укажите данные справки о стоимости выполненных работ и приложите файл для архива.</p>

        <div id="ok" class="status-pane status-ok">Справка сохранена.</div>
        <div id="err" class="status-pane status-err">Не удалось сохранить справку.</div>

        <form id="ks3Form">
          <div class="grid-2">
            <div class="row">
              <label for="statementNumber">Номер справки *</label>
              <input id="statementNumber" required placeholder="КС-3 №15/2024">
            </div>
            <div class="row">
              <label for="statementDate">Дата справки *</label>
              <input id="statementDate" type="date" required>
            </div>
          </div>

          <div class="grid-2">
            <div class="row">
              <label for="counterpartyId">Подрядчик *</label>
              <select id="counterpartyId" required>
                <option value="" selected disabled>Выберите подрядчика</option>
              </select>
              <div class="muted text-note" id="counterpartyHint">Загрузка подрядчиков…</div>
            </div>
            <div class="row">
              <label for="objectId">Объект</label>
              <select id="objectId">
                <option value="" selected>Не выбран</option>
              </select>
              <div class="muted text-note" id="objectsHint">Загрузка объектов…</div>
            </div>
          </div>

          <div class="grid-2">
            <div class="row">
              <label for="periodStart">Период работ (с)</label>
              <input id="periodStart" type="date">
            </div>
            <div class="row">
              <label for="periodEnd">Период работ (по)</label>
              <input id="periodEnd" type="date">
            </div>
          </div>

          <div class="grid-2">
            <div class="row">
              <label for="amountCurrent">Сумма за период *</label>
              <input id="amountCurrent" required inputmode="decimal" placeholder="350 000">
              <div class="muted text-note">Промежуточная сумма за отчётный период, без указания валюты.</div>
            </div>
            <div class="row">
              <label for="amountTotal">Накопительный итог</label>
              <input id="amountTotal" inputmode="decimal" placeholder="1 250 000">
              <div class="muted text-note">Опционально: сумма работ с начала договора.</div>
            </div>
          </div>

          <div class="row">
            <label for="ks2Reference">Связанный акт КС-2</label>
            <input id="ks2Reference" placeholder="Например, КС-2 №45 от 12.03.2024">
          </div>

          <div class="row">
            <label for="notes">Комментарии</label>
            <textarea id="notes" placeholder="Дополнительные пояснения для бухгалтерии"></textarea>
          </div>

          <div class="row">
            <label for="fileInput">Файл справки *</label>
            <div class="file-box">
              <input id="fileInput" type="file" accept=".pdf,.doc,.docx,.xls,.xlsx" required>
              <span class="file-hint">Загрузите подписанную справку или выгрузку из ПТО (до 20 МБ).</span>
              <span id="fileName" class="file-name" hidden></span>
            </div>
          </div>

          <div class="row">
            <label for="approversDisplay">Согласующие</label>
            <div id="approversSelect" class="approver-search">
              <div id="approversDisplay" class="approver-selected empty" aria-live="polite">Загружаем сотрудников…</div>
              <div class="approver-search__field">
                <input id="approversSearch" type="search" placeholder="Начните вводить фамилию, должность или email" autocomplete="off" spellcheck="false">
              </div>
              <div id="approversOptions" class="approver-options" role="listbox" aria-multiselectable="true"></div>
            </div>
            <div class="muted text-note" id="approversHelp">Загружаем сотрудников…</div>
          </div>

          <div class="actions">
            <button id="submitBtn" class="btn btn-primary" type="submit">Сохранить</button>
            <button class="btn btn-ghost" type="button" id="resetBtn">Очистить форму</button>
          </div>
        </form>
      </section>
    </div>
  </div>

  <script type="module">
    import supabase, { requireSession } from "./supabaseClient.js";
        import { createApprovalPicker } from "./approvalPicker.js";
        const headerReady = window.headerReady || Promise.resolve();
    const STORAGE_BUCKET = "contract-docs";
    const TABLE_NAME = "ks3_certificates";

    await headerReady;

    const okBox = document.getElementById("ok");
    const errBox = document.getElementById("err");
    const form = document.getElementById("ks3Form");
    const submitBtn = document.getElementById("submitBtn");
    const resetBtn = document.getElementById("resetBtn");
    const fileInput = document.getElementById("fileInput");
    const fileNameLabel = document.getElementById("fileName");
    const counterpartySelect = document.getElementById("counterpartyId");
    const counterpartyHint = document.getElementById("counterpartyHint");
    const objectSelect = document.getElementById("objectId");
    const objectsHint = document.getElementById("objectsHint");
    const approvalPicker = createApprovalPicker({
      supabase,
      wrapper: "approversSelect",
      display: "approversDisplay",
      search: "approversSearch",
      options: "approversOptions",
      help: "approversHelp"
    });

    function showOk(message){
      okBox.textContent = message;
      okBox.style.display = "block";
      errBox.style.display = "none";
    }

    function showErr(message){
      errBox.textContent = message;
      errBox.style.display = "block";
      okBox.style.display = "none";
    }

    function sanitizeFilename(name){
      return (name || "document")
        .replace(/[\\\s]+/g, "-")
        .replace(/[^0-9A-Za-zА-Яа-яЁё_.-]/g, "-")
        .replace(/-+/g, "-")
        .replace(/^(-|\.)+/, "")
        .slice(0, 120) || "document";
    }

    function parseAmount(value){
      const trimmed = (value || "").trim();
      if (!trimmed) return null;
      const normalized = trimmed.replace(/\s+/g, "").replace(',', '.');
      const num = Number.parseFloat(normalized);
      return Number.isFinite(num) ? num : null;
    }

    async function loadCounterparties(){
      try{
        const { data, error } = await supabase
          .from("counterparties")
          .select("id, name, type")
          .order("name", { ascending: true });
        if (error) throw error;
        if (!data?.length){
          counterpartyHint.textContent = "Нет контрагентов. Добавьте их в разделе Контрагенты.";
          counterpartySelect.disabled = true;
          return;
        }
        const frag = document.createDocumentFragment();
        data.forEach((row)=>{
          const option = document.createElement("option");
          option.value = row.id;
          option.textContent = row.name || "Без названия";
          option.dataset.type = row.type || "";
          frag.appendChild(option);
        });
        counterpartySelect.appendChild(frag);
        counterpartySelect.disabled = false;
        counterpartyHint.textContent = "Выберите подрядчика.";
      }catch(error){
        console.error("Не удалось загрузить контрагентов", error);
        counterpartyHint.textContent = "Ошибка загрузки контрагентов.";
        counterpartySelect.disabled = true;
      }
    }

    async function loadObjects(){
      try{
        const { data, error } = await supabase
          .from("objects")
          .select("id, title, status")
          .eq("status", "активен")
          .order("title", { ascending: true });
        if (error) throw error;
        if (!data?.length){
          objectsHint.textContent = "Нет активных объектов. Добавьте объект в разделе \"Объекты\".";
          objectSelect.disabled = true;
          return;
        }
        const frag = document.createDocumentFragment();
        data.forEach((row)=>{
          const option = document.createElement("option");
          option.value = row.id;
          option.textContent = row.title || "Без названия";
          frag.appendChild(option);
        });
        objectSelect.appendChild(frag);
        objectSelect.disabled = false;
        objectsHint.textContent = "Привяжите справку к объекту при необходимости.";
      }catch(error){
        console.error("Не удалось загрузить объекты", error);
        objectsHint.textContent = "Ошибка загрузки объектов.";
        objectSelect.disabled = true;
      }
    }

    fileInput.addEventListener("change", ()=>{
      const file = fileInput.files?.[0];
      if (file){
        fileNameLabel.textContent = `${file.name} (${(file.size / 1024 / 1024).toFixed(2)} МБ)`;
        fileNameLabel.hidden = false;
      }else{
        fileNameLabel.hidden = true;
      }
    });

    resetBtn.addEventListener("click", ()=>{
      form.reset();
      fileNameLabel.hidden = true;
      okBox.style.display = "none";
      errBox.style.display = "none";
      if (counterpartySelect.options.length) counterpartySelect.selectedIndex = 0;
      if (objectSelect.options.length) objectSelect.selectedIndex = 0;
      approvalPicker.reset();
    });

    form.addEventListener("submit", async (event)=>{
      event.preventDefault();
      okBox.style.display = "none";
      errBox.style.display = "none";

      const file = fileInput.files?.[0];
      if (!file){
        showErr("Прикрепите файл справки.");
        return;
      }
      if (file.size > 20 * 1024 * 1024){
        showErr("Файл превышает 20 МБ.");
        return;
      }

      if (!counterpartySelect.value){
        showErr("Выберите подрядчика.");
        return;
      }

      const amountCurrentValue = parseAmount(document.getElementById("amountCurrent").value);
      if (amountCurrentValue === null){
        showErr("Проверьте сумму за период. Используйте только цифры и разделитель . или ,");
        return;
      }

      const amountTotalValue = parseAmount(document.getElementById("amountTotal").value);
      if (amountTotalValue !== null && amountTotalValue < amountCurrentValue){
        showErr("Накопительный итог не может быть меньше суммы за период.");
        return;
      }

      let session;
      try{
        session = await requireSession();
      }catch(authError){
        showErr(authError.message || "Необходимо авторизоваться.");
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = "Сохранение…";

      try{
        const recordId = crypto.randomUUID();
        const sanitizedName = sanitizeFilename(file.name);
        const storagePath = `${session.user.id}/${recordId}/${sanitizedName}`;

        const { error: uploadError } = await supabase
          .storage
          .from(STORAGE_BUCKET)
          .upload(storagePath, file, {
            upsert: true,
            contentType: file.type || "application/octet-stream"
          });
        if (uploadError){
          throw uploadError;
        }

        const counterpartyOption = counterpartySelect.options[counterpartySelect.selectedIndex];
        const approverIds = approvalPicker.getSelectedIds();
        const approvalPayload = approverIds.length ? {
          approver_ids: approverIds,
          approver_names: approvalPicker.getSelectedNames()
        } : null;
        const payload = {
          id: recordId,
          statement_number: document.getElementById("statementNumber").value.trim(),
          statement_date: document.getElementById("statementDate").value || null,
          created_by: session.user.id,
          counterparty_id: counterpartySelect.value,
          counterparty_name: counterpartyOption?.textContent || null,
          counterparty_type: counterpartyOption?.dataset?.type || null,
          object_id: objectSelect.value || null,
          period_start: document.getElementById("periodStart").value || null,
          period_end: document.getElementById("periodEnd").value || null,
          amount_current: amountCurrentValue,
          amount_total: amountTotalValue,
          ks2_reference: document.getElementById("ks2Reference").value.trim() || null,
          notes: document.getElementById("notes").value.trim() || null,
          file_path: storagePath,
          file_name: sanitizedName,
          file_type: file.type || null,
          file_size: file.size,
          approver_ids: approverIds,
          approval: approvalPayload,
          status: "draft"
        };

        const { error: insertError } = await supabase
          .from(TABLE_NAME)
          .insert(payload);
        if (insertError){
          await supabase.storage.from(STORAGE_BUCKET).remove([storagePath]).catch(()=>{});
          throw insertError;
        }

        showOk("Справка сохранена.");
        form.reset();
        fileNameLabel.hidden = true;
        if (counterpartySelect.options.length) counterpartySelect.selectedIndex = 0;
        if (objectSelect.options.length) objectSelect.selectedIndex = 0;
        approvalPicker.reset();
      }catch(error){
        console.error("Ошибка сохранения справки КС-3", error);
        showErr(error.message || "Не удалось сохранить справку КС-3.");
      }finally{
        submitBtn.disabled = false;
        submitBtn.textContent = "Сохранить";
      }
    });
    await requireSession();
    approvalPicker.loadDirectory().catch((error)=>{
      console.error("Не удалось загрузить согласующих", error);
    });
    await Promise.all([loadCounterparties(), loadObjects()]);

    supabase.auth.onAuthStateChange((_evt, session)=>{
      if (!session){
        location.replace("./index.html");
        return;
      }
      approvalPicker.loadDirectory().catch((error)=>{
        console.error("Не удалось обновить список согласующих", error);
      });
    });
  </script>
</body>
</html>
