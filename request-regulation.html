<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ProStroy — Шаблон регламента</title>
  <meta name="color-scheme" content="dark">
  <link rel="stylesheet" href="assets/styles/base.css">
  <link rel="stylesheet" href="assets/styles/header.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js" defer></script>
  <script src="/js/supabaseClient.js" defer></script>
  <script src="/header.js" defer></script>
</head>
<body style="--bg-video-filter: brightness(0.7);">
  <video class="bg" autoplay muted loop playsinline preload="auto">
    <source src="https://assets.mixkit.co/videos/30431/30431-720.mp4" type="video/mp4">
  </video>

  <div id="header"></div>

  <div class="wrap">
    <div class="page">
      <section class="card">
        <h1>Регламент процесса</h1>
        <p>Структурируйте ключевые элементы будущего регламента: область применения, роли, последовательность этапов и контроль. Мы подготовили блоки, которые используют крупные международные компании и государственные стандарты управления процессами.</p>

        <form id="regForm">
          <div class="grid-2">
            <div class="row">
              <label for="regTitle">Название регламента *</label>
              <input id="regTitle" required placeholder="Регламент управления изменениями">
            </div>
            <div class="row">
              <label for="regScope">Область применения *</label>
              <input id="regScope" required placeholder="Центральный офис, филиалы, подрядчики">
            </div>
          </div>

          <div class="row">
            <label for="purpose">Цель регламента *</label>
            <textarea id="purpose" required placeholder="Опишите, какие задачи решает документ и какую ценность создаёт"></textarea>
          </div>

          <div class="grid-2">
            <div class="row">
              <label for="terms">Термины и сокращения</label>
              <textarea id="terms" placeholder="Укажите определения, которые нужно закрепить"></textarea>
            </div>
            <div class="row">
              <label for="inputs">Входные данные (инициаторы, документы)</label>
              <textarea id="inputs" placeholder="Например: обращение заказчика, проект договора, смета"></textarea>
            </div>
          </div>

          <div class="section-card">
            <h3>Этапы процесса</h3>
            <div class="muted">Добавьте шаги в логической последовательности. В описании фиксируйте ответственных и ожидаемый результат.</div>
            <div id="stepsList" class="section-list"></div>
            <button type="button" class="btn btn-ghost" id="addStep">+ Добавить этап</button>
          </div>

          <div class="section-card">
            <h3>Роли и ответственность</h3>
            <div class="muted">Определите владельца процесса, исполнителей, контролёров и заинтересованные стороны.</div>
            <div id="rolesList" class="section-list"></div>
            <button type="button" class="btn btn-ghost" id="addRole">+ Добавить роль</button>
          </div>

          <div class="grid-2">
            <div class="row">
              <label for="controls">Контроль и KPI</label>
              <textarea id="controls" placeholder="Способы контроля, периметр аудиторов, KPI процесса"></textarea>
            </div>
            <div class="row">
              <label for="documents">Приложения и формы</label>
              <textarea id="documents" placeholder="Шаблоны, формы актов, чек-листы, ссылки на IT-системы"></textarea>
            </div>
          </div>

          <div class="row">
            <label for="revision">Порядок пересмотра</label>
            <textarea id="revision" placeholder="Периодичность пересмотра, ответственные за обновление, уведомления"></textarea>
          </div>

          <div class="actions">
            <button class="btn btn-primary" type="submit">Сформировать текст</button>
            <button class="btn btn-ghost" type="button" id="copyBtn">Скопировать</button>
            <button class="btn btn-ghost" type="button" id="downloadBtn">Скачать TXT</button>
          </div>
        </form>
      </section>

      <section class="card">
        <h2>Предпросмотр</h2>
        <div id="preview" class="preview">Заполните ключевые блоки, и регламент будет сформирован автоматически.</div>
      </section>
    </div>
  </div>

  <script type="module">
    const headerReady = window.headerReady || Promise.resolve();
    
    await headerReady;

    const byId = (id)=>document.getElementById(id);
    const steps = [];
    const roles = [];

    const stepsList = byId("stepsList");
    const rolesList = byId("rolesList");
    const preview = byId("preview");

    function renderCollection(list, items, defaultsLabel){
      list.innerHTML = "";
      if (!items.length){
        const placeholder = document.createElement("div");
        placeholder.className = "muted";
        placeholder.textContent = defaultsLabel;
        list.appendChild(placeholder);
      }
      items.forEach((item, idx)=>{
        const box = document.createElement("div");
        box.className = "section-card";
        box.style.padding = "14px";
        box.innerHTML = `<strong>${item.title || `Элемент ${idx+1}`}</strong><div class="muted">${item.description || ""}</div>`;
        const btn = document.createElement("button");
        btn.className = "btn btn-ghost";
        btn.type = "button";
        btn.textContent = "Удалить";
        btn.style.marginTop = "10px";
        btn.addEventListener("click", ()=>{
          items.splice(idx, 1);
          renderAll();
        });
        box.appendChild(btn);
        list.appendChild(box);
      });
    }

    function renderAll(){
      renderCollection(stepsList, steps, "Этапы ещё не добавлены.");
      renderCollection(rolesList, roles, "Роли не определены.");
    }

    renderAll();

    function promptStep(){
      const title = window.prompt("Название этапа (например, \"Подготовка заявки\"):");
      if (title == null) return null;
      const description = window.prompt("Описание, ответственные, результат:");
      if (description == null) return null;
      return { title: title.trim(), description: description.trim() };
    }

    function promptRole(){
      const title = window.prompt("Роль / должность:");
      if (title == null) return null;
      const description = window.prompt("Зона ответственности и ключевые обязанности:");
      if (description == null) return null;
      return { title: title.trim(), description: description.trim() };
    }

    byId("addStep").addEventListener("click", ()=>{
      const item = promptStep();
      if (item) { steps.push(item); renderAll(); }
    });

    byId("addRole").addEventListener("click", ()=>{
      const item = promptRole();
      if (item) { roles.push(item); renderAll(); }
    });

    function formatPreview(){
      const title = byId("regTitle").value.trim() || "[Название регламента]";
      const scope = byId("regScope").value.trim() || "[Область применения]";
      const purpose = byId("purpose").value.trim() || "[Цель документа]";
      const terms = byId("terms").value.trim();
      const inputs = byId("inputs").value.trim();
      const controls = byId("controls").value.trim();
      const documents = byId("documents").value.trim();
      const revision = byId("revision").value.trim();

      let text = `${title}\n\n1. Общие положения\n1.1. Область применения: ${scope}.\n1.2. Цель регламента: ${purpose}.\n`;

      if (terms){
        text += `1.3. Термины и сокращения:\n${terms}\n`;
      }
      if (inputs){
        text += `1.4. Входные данные и инициаторы:\n${inputs}\n`;
      }

      text += `\n2. Участники процесса и ответственность\n`;
      if (roles.length){
        roles.forEach((role, idx)=>{
          text += `${idx+1}. ${role.title || "[роль]"}: ${role.description || "описание"}.\n`;
        });
      }else{
        text += "2.1. [Опишите роли и ответственность].\n";
      }

      text += `\n3. Порядок выполнения процесса\n`;
      if (steps.length){
        steps.forEach((step, idx)=>{
          text += `3.${idx+1}. ${step.title || "Шаг"}. ${step.description || "Описание"}.\n`;
        });
      }else{
        text += "3.1. [Добавьте последовательность этапов].\n";
      }

      if (controls){
        text += `\n4. Контроль и показатели эффективности\n${controls}\n`;
      }

      if (documents){
        text += `\n5. Документы и формы\n${documents}\n`;
      }

      if (revision){
        text += `\n6. Порядок пересмотра\n${revision}\n`;
      }

      text += "\nПриложение: при необходимости укажите формы, чек-листы или схемы процесса.\n";

      preview.textContent = text;
      return text;
    }

    byId("regForm").addEventListener("submit", (evt)=>{
      evt.preventDefault();
      formatPreview();
      preview.scrollIntoView({ behavior:"smooth", block:"start" });
    });

    function copyPreview(){
      const text = formatPreview();
      navigator.clipboard?.writeText(text).then(()=>{
        window.alert("Текст регламента скопирован в буфер обмена.");
      }).catch(()=> window.alert("Не удалось скопировать текст."));
    }

    function downloadPreview(){
      const text = formatPreview();
      const blob = new Blob([text], { type:"text/plain;charset=utf-8" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = `reglament-${byId("regTitle").value || "draft"}.txt`;
      link.click();
      URL.revokeObjectURL(link.href);
    }

    byId("copyBtn").addEventListener("click", copyPreview);
    byId("downloadBtn").addEventListener("click", downloadPreview);
  </script>
</body>
</html>
