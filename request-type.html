<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ProStroy — Заявки</title>
  <meta name="color-scheme" content="dark">
  <link rel="stylesheet" href="assets/styles/base.css">
  <link rel="stylesheet" href="assets/styles/header.css">
  <style>
    :root{
      --surface:rgba(6,10,18,.58);
      --border-soft:rgba(255,255,255,.12);
      --accent:#22c55e;
    }
    body{margin:0;min-height:100dvh;background:var(--bg,#0b1220);color:var(--text,#eef3f9);font-family:var(--font-sans,system-ui,-apple-system,"Segoe UI",Roboto,Inter,Arial)}
    video.bg{position:fixed;inset:0;width:100%;height:100%;object-fit:cover;z-index:-2;filter:brightness(.72)}
    .overlay{position:fixed;inset:0;z-index:-1;background:linear-gradient(180deg,rgba(5,8,13,.2),rgba(5,8,13,.72))}
    .wrap{padding:24px}
    .page{max-width:1200px;margin:0 auto;display:grid;gap:20px}
    .card{background:var(--surface);border:1px solid var(--border-soft);border-radius:18px;padding:20px 24px;backdrop-filter:blur(10px);box-shadow:0 18px 40px rgba(0,0,0,.45)}
    .req-head{display:flex;justify-content:space-between;align-items:flex-start;gap:20px;flex-wrap:wrap}
    .newreq-wrap{display:flex;flex-direction:column;gap:12px;align-items:flex-end;width:100%}
    .req-menu{display:none;width:100%;margin-top:12px;padding:24px;border-radius:18px;background:var(--surface);border:1px solid var(--border-soft);box-shadow:0 26px 60px rgba(0,0,0,.5);backdrop-filter:blur(14px);gap:22px;box-sizing:border-box}
    .req-menu.is-open{display:grid}
    .req-menu-section{display:grid;gap:14px}
    .req-menu-section + .req-menu-section{border-top:1px solid rgba(255,255,255,.08);padding-top:18px;margin-top:6px}
    .req-menu-title{font-size:1rem;font-weight:650;letter-spacing:.01em;text-transform:none;color:#fff}
    .req-menu-grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
    .req-menu-link{display:flex;flex-direction:column;gap:6px;padding:16px 18px;border-radius:14px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.08);text-decoration:none;color:inherit;font-size:.95rem;line-height:1.3;transition:background .2s ease,border-color .2s ease,transform .16s ease}
    .req-menu-link:hover{background:rgba(34,197,94,.18);border-color:rgba(34,197,94,.38);color:#f4fff8;transform:translateY(-2px)}
    .req-menu-link-title{font-weight:600}
    .muted{color:var(--muted,#a9b4c7)}
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:10px 16px;border-radius:12px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.08);color:inherit;text-decoration:none;font-weight:600;cursor:pointer;transition:filter .2s ease,border-color .2s ease}
    .btn:hover{filter:brightness(1.05);border-color:rgba(255,255,255,.28)}
    .btn.action{background:#22c55e;border:0;color:#0b1b14;box-shadow:0 10px 24px rgba(34,197,94,.18)}
    .card-grid{display:grid;gap:20px;grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
    .panel-soft{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:18px;display:grid;gap:12px}
    .panel-soft h3{margin:0;font-size:1rem}
    .panel-soft ul{margin:0;padding-left:18px;display:grid;gap:6px;font-size:.95rem}
    .current-pill{display:inline-flex;align-items:center;padding:6px 14px;border-radius:999px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.08);font-weight:600;font-size:.82rem;text-transform:uppercase;letter-spacing:.08em;margin-bottom:12px}
    .req-grid{display:grid;gap:14px}
    .req-card{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);border-radius:14px;padding:16px;display:grid;gap:12px;transition:transform .18s ease, border-color .18s ease}
    .req-card:hover{transform:translateY(-2px);border-color:rgba(34,197,94,.4)}
    .req-card h3{margin:0;font-size:1.05rem}
    .req-card .muted{font-size:.9rem}
    .req-card .tags{display:flex;flex-wrap:wrap;gap:8px;font-size:.82rem}
    .req-card .tag{padding:4px 10px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12)}
    .req-card-footer{display:flex;flex-wrap:wrap;gap:10px;justify-content:space-between;align-items:center}
    .empty-state{padding:30px;text-align:center;color:var(--muted)}
    @media(max-width:720px){
      .wrap{padding:16px}
      .newreq-wrap{align-items:stretch}
      .newreq-wrap > button{align-self:flex-end}
      .req-menu{padding:20px}
      .req-menu-grid{grid-template-columns:minmax(0,1fr)}
      .req-card-footer{flex-direction:column;align-items:flex-start}
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js" defer></script>
  <script src="/js/supabaseClient.js" defer></script>
  <script src="/header.js" defer></script>
</head>
<body class="requests-page">
  <video class="bg" autoplay muted loop playsinline preload="auto">
    <source src="https://assets.mixkit.co/videos/30431/30431-720.mp4" type="video/mp4">
  </video>
  <div class="overlay"></div>

  <div id="header"></div>

  <div class="wrap">
    <div class="page">
      <section class="card req-head">
        <div>
          <h1 id="req-title">Заявки</h1>
          <p class="muted">Выберите шаблон заявки и запустите процесс в пару кликов.</p>
        </div>
        <div class="newreq-wrap">
          <button id="btnNewRequest" class="btn action" type="button">➕ Новая заявка</button>
          <div id="newRequestMenu" class="req-menu" aria-hidden="true"></div>
        </div>
      </section>

      <section class="card" id="current-card" hidden>
        <div class="grid-2 card-grid">
          <div>
            <div class="current-pill" id="req-category">Категория</div>
            <h2 id="req-name">Название заявки</h2>
            <p id="req-summary" class="muted">Описание заявки и когда её использовать.</p>
            <div class="panel-soft">
              <h3>Что нужно подготовить</h3>
              <ul id="req-sections"></ul>
            </div>
          </div>
          <aside class="panel-soft">
            <h3>Чек-лист перед запуском</h3>
            <ul id="req-checklist"></ul>
            <div class="mt-3">
              <a id="req-start" class="btn ghost" href="./request-new.html">Открыть шаблон</a>
            </div>
          </aside>
        </div>
      </section>

      <section class="card" id="not-found" hidden>
        <h2>Тип заявки не найден</h2>
        <p class="muted">Выберите подходящий шаблон из списка ниже.</p>
      </section>

      <section class="card">
        <h2>Все заявки</h2>
        <div id="req-nav" class="req-grid"></div>
      </section>
    </div>
  </div>

  <script type="module">
    import { REQUEST_TYPES } from "./request-types.js";
    import { setupNewRequestMenu } from "./js/newRequestMenu.js";
    const headerReady = window.headerReady || Promise.resolve();

    await headerReady;
    setupNewRequestMenu({
      button: document.getElementById("btnNewRequest"),
      container: document.getElementById("newRequestMenu")
    });

    const params = new URLSearchParams(location.search);
    const slug = params.get("doc") || "unspecified";

    const card = document.getElementById("current-card");
    const notFound = document.getElementById("not-found");
    const listBox = document.getElementById("req-nav");
    const startBtn = document.getElementById("req-start");

    const creationRoutes = {
      "lease-general": "./request-lease-general.html",
      "lease-equipment": "./request-lease-equipment.html",
      "protocol-oss": "./request-protocol-oss.html",
      "external-subcontract": "./request-external-subcontract.html",
      "individual-subcontract": "./request-individual-subcontract.html",
      "counterparty-review": "./request-counterparty-review.html",
      "finance-gph": "./request-payment-order.html?type=gph",
      "finance-salary": "./request-payment-order.html?type=salary",
      "finance-advance": "./request-advance-report.html",
      "finance-taxes": "./request-payment-order.html?type=tax",
      "finance-refund": "./request-payment-order.html?type=refund",
      "finance-project": "./request-payment-order.html?type=project",
      "finance-bank": "./request-payment-order.html",
      incoming: "./request-incoming.html",
      internal: "./request-internal.html",
      outgoing: "./request-outgoing.html",
      "agreement-request": "./request-agreement-request.html",
      donation: "./request-donation.html",
      subsidy: "./request-subsidy.html",
      pretrial: "./request-pretrial.html",
      unspecified: "./request-unspecified.html"
    };

    const escapeHtml = (value)=>String(value ?? "").replace(/[&<>"']/g, ch => ({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[ch]||ch));

    const type = REQUEST_TYPES.find((item)=> item.slug === slug);

    if (type){
      card.hidden = false;
      document.title = `ProStroy — ${type.title}`;
      document.getElementById("req-name").textContent = type.title;
      document.getElementById("req-category").textContent = type.category || "Заявки";
      document.getElementById("req-summary").textContent = type.summary || "";

      const sections = document.getElementById("req-sections");
      sections.innerHTML = "";
      (type.recommendedSections || []).forEach((item)=>{
        const li = document.createElement("li");
        li.textContent = item;
        sections.appendChild(li);
      });

      const checklist = document.getElementById("req-checklist");
      checklist.innerHTML = "";
      (type.checklist || []).forEach((item)=>{
        const li = document.createElement("li");
        li.textContent = item;
        checklist.appendChild(li);
      });

      if (startBtn){
        const href = creationRoutes[type.slug] || "./request-new.html";
        startBtn.href = href;
        startBtn.textContent = href.includes("request-new") ? "Открыть шаблон" : "Заполнить форму";
      }
    }else{
      notFound.hidden = false;
      if (startBtn){
        startBtn.href = "./request-new.html";
        startBtn.textContent = "Открыть шаблон";
      }
    }

    // Render navigation grouped by categories
    const grouped = REQUEST_TYPES.reduce((acc, item)=>{
      const bucket = item.category || "Прочие";
      acc[bucket] = acc[bucket] || [];
      acc[bucket].push(item);
      return acc;
    }, {});

    listBox.innerHTML = "";
    Object.entries(grouped).forEach(([category, items])=>{
      const section = document.createElement("section");
      const heading = document.createElement("h3");
      heading.textContent = category;
      section.appendChild(heading);

      const grid = document.createElement("div");
      grid.className = "req-grid";

      items.forEach(item => {
        const cardLink = document.createElement("a");
        cardLink.className = "req-card";
        cardLink.href = `./request-type.html?doc=${encodeURIComponent(item.slug)}`;
        cardLink.innerHTML = `
          <div>
            <h3>${escapeHtml(item.title)}</h3>
            <div class="muted">${escapeHtml(item.summary || "")}</div>
          </div>
          <div class="req-card-footer">
            <div class="tags">
              <span class="tag">${escapeHtml(item.category || "Прочие")}</span>
              ${(item.tags || []).map(tag => `<span class="tag">${escapeHtml(tag)}</span>`).join("")}
            </div>
            <span class="btn ghost sm">Открыть</span>
          </div>
        `;
        if (item.slug === slug){
          cardLink.style.borderColor = "rgba(34,197,94,.45)";
        }
        grid.appendChild(cardLink);
      });

      section.appendChild(grid);
      listBox.appendChild(section);
    });
  </script>
</body>
</html>
