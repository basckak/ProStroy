<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ProStroy — Заявки</title>
  <meta name="color-scheme" content="dark">
  <link rel="stylesheet" href="assets/styles/base.css">
  <link rel="stylesheet" href="assets/styles/header.css">
  <style>
    :root{
      --surface:rgba(6,10,18,.58);
      --surface-strong:rgba(8,14,24,.74);
      --border-soft:rgba(255,255,255,.12);
      --accent:#22c55e;
    }
    body{margin:0;min-height:100dvh;background:var(--bg,#0b1220);color:var(--text,#eef3f9);font-family:var(--font-sans,system-ui,-apple-system,"Segoe UI",Roboto,Inter,Arial);overflow-y:scroll}
    video.bg{position:fixed;inset:0;width:100%;height:100%;object-fit:cover;z-index:-2;filter:brightness(.72)}
    .overlay{position:fixed;inset:0;z-index:-1;background:linear-gradient(180deg,rgba(5,8,13,.2),rgba(5,8,13,.72))}
    .wrap{padding:20px}
    .page{max-width:1200px;margin:0 auto;display:grid;gap:18px}
    .card{background:var(--surface);border:1px solid var(--border-soft);border-radius:18px;padding:18px 22px;backdrop-filter:blur(10px);box-shadow:0 18px 40px rgba(0,0,0,.42)}
    .req-head{display:flex;justify-content:space-between;align-items:center;gap:16px;flex-wrap:wrap}
    .req-head > div{flex:1 1 600px}
    .req-head .muted{margin-top:6px;color:var(--muted,#a9b4c7)}

    .newreq-wrap{display:flex;flex-direction:column;gap:10px;align-items:flex-end}
    .req-menu{display:none;width:100%;margin-top:8px;padding:18px;border-radius:16px;background:var(--surface-strong);border:1px solid var(--border-soft);box-shadow:0 18px 40px rgba(0,0,0,.42);backdrop-filter:blur(12px);gap:18px;box-sizing:border-box}
    .req-menu.is-open{display:grid}
    .req-menu-section{display:grid;gap:12px}
    .req-menu-section + .req-menu-section{border-top:1px solid rgba(255,255,255,.08);padding-top:16px;margin-top:6px}
    .req-menu-title{font-size:1rem;font-weight:600;color:#f8fafc}
    .req-menu-grid{display:grid;gap:10px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
    .req-menu-link{display:flex;flex-direction:column;gap:6px;padding:14px 16px;border-radius:14px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);text-decoration:none;color:inherit;font-size:.95rem;line-height:1.3;transition:background .2s ease,border-color .2s ease,transform .16s ease}
    .req-menu-link:hover{background:rgba(34,197,94,.16);border-color:rgba(34,197,94,.32);transform:translateY(-2px);color:#f4fff8}
    .req-menu-link-title{font-weight:600}

    .muted{color:var(--muted,#a9b4c7)}

    .filters{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .filters input,.filters select{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.18);border-radius:12px;padding:10px 14px;color:inherit;font:inherit;min-width:180px}
    .filters input{flex:1 1 260px}

    .btn{display:inline-flex;align-items:center;justify-content:center;padding:10px 16px;border-radius:12px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.08);color:inherit;font-weight:600;text-decoration:none;cursor:pointer;transition:filter .2s ease,border-color .2s ease,transform .1s ease}
    .btn:hover{filter:brightness(1.05);border-color:rgba(255,255,255,.28)}
    .btn:active{transform:translateY(1px)}
    .btn.ghost{background:transparent}
    .btn.action{background:var(--accent);border:0;color:#082d18;box-shadow:0 12px 26px rgba(34,197,94,.24)}
    .btn.sm{padding:6px 10px;font-size:.85rem;border-radius:10px}

    .table-wrap{overflow-x:auto}
    table.req-table{width:100%;border-collapse:collapse;min-width:720px;font-size:.95rem;background:rgba(8,14,24,.6);border-radius:14px;overflow:hidden}
    table.req-table thead{background:rgba(255,255,255,.06)}
    table.req-table th,table.req-table td{padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.08);text-align:left;vertical-align:middle}
    table.req-table th{font-size:.82rem;letter-spacing:.08em;text-transform:uppercase;color:rgba(226,232,240,.76)}
    table.req-table td .muted{display:block;margin-top:4px;font-size:.82rem}
    table.req-table tbody tr:nth-child(even){background:rgba(255,255,255,.02)}
    table.req-table tbody tr:hover{background:rgba(34,197,94,.14)}
    table.req-table td.actions{text-align:right}
    table.req-table td.actions .btn{min-width:96px}

    .status-badge{display:inline-flex;align-items:center;gap:6px;padding:4px 12px;border-radius:999px;font-size:.78rem;font-weight:600;border:1px solid transparent}
    .status-draft{background:rgba(148,163,184,.16);color:#e2e8f0;border-color:rgba(148,163,184,.28)}
    .status-on_review{background:rgba(56,189,248,.18);color:#bae6fd;border-color:rgba(56,189,248,.3)}
    .status-approved{background:rgba(34,197,94,.18);color:#86efac;border-color:rgba(34,197,94,.32)}
    .status-completed{background:rgba(129,140,248,.18);color:#c7d2fe;border-color:rgba(129,140,248,.32)}
    .status-rejected{background:rgba(248,113,113,.18);color:#fecaca;border-color:rgba(248,113,113,.32)}
    .status-other{background:rgba(148,163,184,.12);color:#e2e8f0;border-color:rgba(148,163,184,.22)}

    .table-footer{display:flex;justify-content:flex-end;margin-top:12px}
    .table-footer.is-hidden{display:none}
    .empty-state,.loader{padding:26px;text-align:center;color:var(--muted,#a9b4c7)}

    @media(max-width:900px){
      .wrap{padding:16px}
      .newreq-wrap{align-items:stretch}
      .newreq-wrap > button{align-self:flex-end}
      .req-menu{padding:16px}
      .req-menu-grid{grid-template-columns:minmax(0,1fr)}
      table.req-table{font-size:.9rem;min-width:0;background:rgba(8,14,24,.72)}
      table.req-table thead{display:none}
      table.req-table tbody tr{display:grid;border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:12px;margin-bottom:12px;overflow:hidden;background:rgba(8,14,24,.72)}
      table.req-table td{border:0;padding:8px 0;text-align:left}
      table.req-table td[data-label]::before{content:attr(data-label) ": ";display:block;font-size:.78rem;letter-spacing:.08em;text-transform:uppercase;color:rgba(226,232,240,.6);margin-bottom:4px}
      table.req-table td.actions{text-align:left}
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js" defer></script>
  <script src="/js/supabaseClient.js" defer></script>
  <script src="/header.js" defer></script>
</head>
<body>
  <video class="bg" autoplay muted loop playsinline preload="auto">
    <source src="https://assets.mixkit.co/videos/30431/30431-720.mp4" type="video/mp4">
  </video>
  <div class="overlay"></div>
  <div id="header"></div>

  <div class="wrap">
    <div class="page">
      <section class="card req-head">
        <div>
          <h1>Заявки</h1>
          <p class="muted">Все заявки с фильтрами и быстрым доступом к карточке.</p>
        </div>
        <div class="newreq-wrap">
          <button id="btnNewRequest" class="btn action" type="button">+ Новая заявка</button>
          <div id="newRequestMenu" class="req-menu" aria-hidden="true"></div>
        </div>
      </section>

      <section class="card">
        <form id="filters" class="filters" autocomplete="off">
          <input id="search" placeholder="Поиск: номер, направление, участник…">
          <select id="statusFilter">
            <option value="">Статус: любой</option>
            <option value="черновик">Черновик</option>
            <option value="на согласовании">На согласовании</option>
            <option value="одобрено">Одобрено</option>
            <option value="отклонено">Отклонено</option>
          </select>
          <input id="fromDate" type="date" aria-label="С даты">
          <input id="toDate" type="date" aria-label="По дату">
          <button class="btn ghost" type="button" id="btnReset">Сброс</button>
          <button class="btn" type="submit">Применить</button>
        </form>
      </section>

      <section class="card">
        <div id="tableContainer" class="table-wrap">
          <div class="loader">Загрузка заявок…</div>
        </div>
        <div class="table-footer is-hidden" id="moreWrap">
          <button id="btnMore" class="btn ghost sm">Показать ещё</button>
        </div>
      </section>
    </div>
  </div>

  <script type="module">
    import supabase, { requireSession } from "./supabaseClient.js";
    import { setupNewRequestMenu } from "./js/newRequestMenu.js";
    const headerReady = window.headerReady || Promise.resolve();

    await headerReady;
    await requireSession({ redirectTo: "./index.html" });

    setupNewRequestMenu({
      button: document.getElementById("btnNewRequest"),
      container: document.getElementById("newRequestMenu")
    });

    const STATUS_META = {
      "draft": { label: "Черновик", class: "status-draft" },
      "черновик": { label: "Черновик", class: "status-draft" },
      "submitted": { label: "На согласовании", class: "status-on_review" },
      "in_review": { label: "На согласовании", class: "status-on_review" },
      "pending": { label: "На согласовании", class: "status-on_review" },
      "на согласовании": { label: "На согласовании", class: "status-on_review" },
      "approved": { label: "Согласовано", class: "status-approved" },
      "одобрено": { label: "Согласовано", class: "status-approved" },
      "rejected": { label: "Отклонено", class: "status-rejected" },
      "отклонено": { label: "Отклонено", class: "status-rejected" },
      "finalized": { label: "Оформлено", class: "status-completed" },
      "final": { label: "Оформлено", class: "status-completed" }
    };
    const TYPE_META = {
      "transport": {
        label: "Заявка",
        subtitle: "Заявка на автотранспорт",
        view: id => `./request-view.html?id=${encodeURIComponent(id)}`,
        edit: id => `./transport.html?id=${encodeURIComponent(id)}`
      },
      "gph": {
        label: "Заявка",
        subtitle: "Заявка на оплату ГПХ",
        view: id => `./request-payment-order.html?type=gph&id=${encodeURIComponent(id)}`,
        edit: id => `./request-payment-order.html?type=gph&id=${encodeURIComponent(id)}`
      }
    };

    const byId = id => document.getElementById(id);
    const tableContainer = byId("tableContainer");
    const btnMore = byId("btnMore");
    const moreWrap = byId("moreWrap");
    const filters = {
      search: byId("search"),
      status: byId("statusFilter"),
      from: byId("fromDate"),
      to: byId("toDate")
    };

    const pageSize = 20;
    let offset = 0;
    let finished = false;
    let hasLoaded = false;

    const escapeHtml = value => String(value ?? "—").replace(/[&<>"']/g, ch => ({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[ch] || ch));
    const formatDate = value => {
      if (!value) return "—";
      const dt = new Date(value);
      return Number.isNaN(dt.getTime()) ? "—" : dt.toLocaleDateString('ru-RU');
    };
    const formatDateTime = value => {
      if (!value) return "—";
      const dt = new Date(value);
      return Number.isNaN(dt.getTime()) ? "—" : dt.toLocaleString('ru-RU');
    };
    const formatBudget = value => {
      if (value == null || value === "") return "—";
      const num = Number(value);
      if (Number.isNaN(num)) return "—";
      return `${num.toLocaleString('ru-RU')} ₽`;
    };
    const initialMessage = '<div class="empty-state">Настройте фильтры и нажмите «Применить», чтобы показать заявки.</div>';
    tableContainer.innerHTML = initialMessage;
    moreWrap.classList.add("is-hidden");

    function renderEmpty(message){
      tableContainer.innerHTML = `<div class="empty-state">${escapeHtml(message)}</div>`;
      moreWrap.classList.add("is-hidden");
    }

    function ensureTable(reset){
      if (reset || !tableContainer.querySelector("table")){
        tableContainer.innerHTML = `
          <table class="req-table">
            <thead>
              <tr>
                <th>№ / название</th>
                <th>Категория</th>
                <th>Период</th>
                <th>Статус</th>
                <th>Бюджет</th>
                <th>Создана</th>
                <th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>`;
      }
      return tableContainer.querySelector("tbody");
    }

    async function fetchAuthorNames(ids){
      if (!ids.length) return {};
      const { data, error } = await supabase.from("profiles").select("id, full_name, login").in("id", ids);
      if (error || !data) return {};
      const map = {};
      data.forEach(row => {
        map[row.id] = row.full_name?.trim() || row.login?.trim() || "Сотрудник";
      });
      return map;
    }

    async function loadRequests(reset=false){
      if (reset){
        hasLoaded = true;
      } else if (!hasLoaded){
        return;
      }
      if (reset){
        offset = 0;
        finished = false;
        tableContainer.innerHTML = '<div class="loader">Загрузка заявок…</div>';
        moreWrap.classList.add("is-hidden");
      }
      if (finished) return;

      let query = supabase
        .from("requests_overview")
        .select("id, request_no, destination, date_from, date_to, status, finance, created_at, user_id, request_type", { count: "exact" });

      const text = (filters.search.value || "").trim();
      if (text){
        const like = `%${text.replace(/%/g, "")}%`;
        query = query.or([
          `request_no.ilike.${like}`,
          `destination.ilike.${like}`
        ].join(","));
      }

      if (filters.status.value){
        query = query.eq("status", filters.status.value);
      }
      if (filters.from.value){
        query = query.gte("created_at", `${filters.from.value}T00:00:00`);
      }
      if (filters.to.value){
        query = query.lte("created_at", `${filters.to.value}T23:59:59`);
      }

      query = query.order("created_at", { ascending:false }).range(offset, offset + pageSize - 1);

      let result;
      try{
        result = await query;
      }catch(error){
        renderEmpty(`Ошибка загрузки: ${escapeHtml(error.message)}`);
        return;
      }

      const rows = result.data || [];
      if (!rows.length && offset === 0){
        renderEmpty("Заявок пока нет.");
        return;
      }

      const userIds = Array.from(new Set(rows.map(r => r.user_id).filter(Boolean)));
      const authors = await fetchAuthorNames(userIds);

      const tbody = ensureTable(reset);
      if (reset) tbody.innerHTML = "";

      rows.forEach(row => {
        const statusInfo = resolveStatus(row.status);
        const tr = document.createElement("tr");
        const directionHtml = formatDirection(row.destination);
        const periodHtml = formatPeriod(row.date_from, row.date_to);
        const typeInfo = TYPE_META[row.request_type] || {
          label: "Заявка",
          subtitle: row.request_type ? row.request_type.toUpperCase() : "Тип не указан",
          view: id => `./request-view.html?id=${encodeURIComponent(id)}`,
          edit: id => `./request-view.html?id=${encodeURIComponent(id)}`
        };
        const authorLine = authors[row.user_id] ? `<div class="muted">${escapeHtml(authors[row.user_id])}</div>` : "";
        const titleBlock = `
          <div>${escapeHtml(row.request_no || "—")}</div>
          ${directionHtml ? `<div class="req-destination">${directionHtml}</div>` : ""}
          ${authorLine}
        `;
        const categoryBlock = `
          <div>${escapeHtml(typeInfo.label || "—")}</div>
          <div class="muted">${escapeHtml(typeInfo.subtitle || "—")}</div>
        `;
        const viewHref = typeof typeInfo.view === "function" ? typeInfo.view(row.id) : `./request-view.html?id=${encodeURIComponent(row.id)}`;
        const editHref = typeof typeInfo.edit === "function" ? typeInfo.edit(row.id) : viewHref;
        tr.innerHTML = `
          <td data-label="№ / название">
            ${titleBlock}
          </td>
          <td data-label="Категория">${categoryBlock}</td>
          <td data-label="Период">${periodHtml}</td>
          <td data-label="Статус"><span class="status-badge ${statusInfo.class}">${escapeHtml(statusInfo.label)}</span></td>
          <td data-label="Бюджет">${escapeHtml(formatBudget(row.finance))}</td>
          <td data-label="Создана">${escapeHtml(formatDateTime(row.created_at))}</td>
          <td data-label="Действия" class="actions">
            <a class="btn ghost sm" href="${viewHref}">Открыть</a>
            <a class="btn ghost sm" href="${editHref}">Редактировать</a>
          </td>`;
        tbody.appendChild(tr);
      });

      offset += rows.length;
      const total = typeof result.count === "number" ? result.count : offset;
      finished = offset >= total;
      moreWrap.classList.toggle("is-hidden", finished);
    }

    document.getElementById("filters").addEventListener("submit", event => {
      event.preventDefault();
      loadRequests(true);
    });

    document.getElementById("btnReset").addEventListener("click", () => {
      filters.search.value = "";
      filters.status.value = "";
      filters.from.value = "";
      filters.to.value = "";
      hasLoaded = false;
      tableContainer.innerHTML = initialMessage;
      moreWrap.classList.add("is-hidden");
    });

    btnMore.addEventListener("click", () => loadRequests(false));

    supabase.auth.onAuthStateChange((_evt, session) => {
      if (!session){
        location.replace("./index.html");
      }
    });

    function resolveStatus(rawStatus){
      if (!rawStatus){
        return { label: "—", class: "status-other" };
      }
      const normalized = rawStatus.toString().trim().toLowerCase();
      if (STATUS_META[normalized]){
        return STATUS_META[normalized];
      }
      return { label: rawStatus, class: "status-other" };
    }

    function formatDirection(destination){
      if (!destination){
        return "—";
      }
      const parts = destination.split("·").map(part => part.trim()).filter(Boolean);
      if (!parts.length){
        return escapeHtml(destination);
      }
      return parts.map(part => `<div>${escapeHtml(part)}</div>`).join("");
    }

    function formatPeriod(from, to){
      const start = formatDate(from);
      const end = formatDate(to);
      if (start === "—" && end === "—"){
        return "—";
      }
      return `<div>${escapeHtml(start)}</div><div class="muted">${escapeHtml(end)}</div>`;
    }
  </script>
</body>
</html>
